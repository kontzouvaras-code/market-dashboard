
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.29.1"
  }
}
</script>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Risk Monitor - Real-Time Dashboard</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%2300d4ff;stop-opacity:1' /%3E%3Cstop offset='100%25' style='stop-color:%230099ff;stop-opacity:1' /%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='100' height='100' rx='20' fill='url(%23grad)'/%3E%3Cpath d='M25 50 L35 40 L45 55 L55 35 L65 45 L75 30' stroke='white' stroke-width='4' fill='none' stroke-linecap='round' stroke-linejoin='round'/%3E%3Ccircle cx='75' cy='30' r='3' fill='white'/%3E%3C/svg%3E">
    
    <!-- Modern Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #111 0%, #000 100%);
            color: #fff;
            padding: 20px;
            min-height: 100vh;
        }
        .container { max-width: 1600px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 40px; padding: 20px; }
        .header-logo {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 10px;
        }
        .logo-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #00d4ff 0%, #0099ff 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 20px rgba(0, 212, 255, 0.4);
        }
        .logo-icon svg {
            width: 30px;
            height: 30px;
        }
        .header h1 {
            font-size: 2.8em;
            font-weight: 800;
            margin-bottom: 8px;
            background: linear-gradient(45deg, #00d4ff, #0099ff, #00d4ff);
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -1px;
            animation: shimmer 3s linear infinite;
        }
        @keyframes shimmer {
            0% { background-position: 0% center; }
            100% { background-position: 200% center; }
        }
        .header-subtitle {
            font-size: 1em;
            color: #888;
            font-weight: 500;
            letter-spacing: 0.5px;
        }
        .header-disclaimer {
            font-size: 0.85em;
            color: #aaa;
            margin-top: 15px;
            padding: 12px 20px;
            background: rgba(255, 165, 2, 0.1);
            border: 1px solid rgba(255, 165, 2, 0.3);
            border-radius: 8px;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            line-height: 1.6;
        }
        .header-disclaimer strong {
            color: #ffa502;
            font-weight: 600;
        }
        
        /* Navigation */
        .navigation {
            margin-top: 25px;
            display: inline-flex;
            background: rgba(0, 0, 0, 0.25);
            border-radius: 12px;
            padding: 6px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .nav-link {
            text-decoration: none;
            color: #aaa;
            padding: 8px 20px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9em;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .nav-link:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }
        .nav-link.active {
            background: linear-gradient(45deg, #00d4ff, #0099ff);
            color: #fff;
            box-shadow: 0 4px 15px rgba(0, 212, 255, 0.3);
        }

        .last-updated { color: #888; font-size: 0.9em; margin-top: 15px; }
        .loading { text-align: center; padding: 40px; font-size: 1.2em; color: #00d4ff; }
        .error {
            background: rgba(255, 71, 87, 0.2);
            border: 1px solid #ff4757;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
            color: #ff4757;
        }
        
        /* Executive Summary */
        .exec-summary {
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.15) 0%, rgba(0, 153, 255, 0.1) 100%);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            border: 2px solid rgba(0, 212, 255, 0.4);
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 212, 255, 0.2);
        }
        .exec-summary-header {
            color: #00d4ff;
            font-size: 1.5em;
            font-weight: 700;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .exec-summary-content {
            font-size: 1.1em;
            line-height: 1.9;
            color: #fff;
            font-weight: 500;
        }
        .tldr-badge {
            background: linear-gradient(45deg, #00d4ff, #0099ff);
            color: white;
            padding: 6px 14px;
            border-radius: 12px;
            font-size: 0.6em;
            font-weight: 700;
            letter-spacing: 1px;
        }
        
        /* Risk Score Meter */
        .risk-meter-container {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .risk-meter-title {
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 20px;
            color: #00d4ff;
            text-align: center;
        }
        .risk-meter {
            position: relative;
            height: 40px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 20px;
            overflow: hidden;
            margin-bottom: 15px;
        }
        .risk-meter-fill {
            height: 100%;
            transition: width 1s ease, background 1s ease;
            border-radius: 20px;
            position: relative;
        }
        .risk-meter-label {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-weight: 700;
            font-size: 1.1em;
            color: #fff;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            z-index: 10;
        }
        .risk-breakdown {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        .risk-factor {
            background: rgba(0, 0, 0, 0.2);
            padding: 10px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9em;
        }
        .risk-factor-label { color: #ccc; }
        .risk-factor-value { font-weight: 600; }
        
        /* Multi-Asset Dashboard */
        .multi-asset-section {
            margin-bottom: 30px;
        }
        .section-header {
            font-size: 1.3em;
            font-weight: 600;
            color: #00d4ff;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(0, 212, 255, 0.3);
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 212, 255, 0.2);
        }
        .card-title { font-size: 1.1em; font-weight: 600; margin-bottom: 5px; color: #00d4ff; }
        .card-subtitle { font-size: 0.85em; color: #888; margin-bottom: 15px; }
        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        .metric:last-child { border-bottom: none; }
        .metric-label { font-size: 0.9em; color: #ccc; }
        .metric-value { font-size: 1.2em; font-weight: 600; }
        
        /* Historical Trend Mini Chart */
        .trend-mini {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
        }
        .trend-label {
            font-size: 0.85em;
            color: #888;
            min-width: 80px;
        }
        .trend-values {
            display: flex;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
        }
        .trend-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #666;
        }
        .trend-value {
            font-size: 0.85em;
            color: #aaa;
            font-family: 'Courier New', monospace;
        }
        .trend-arrow-mini {
            font-size: 1.2em;
            margin-left: 5px;
        }
        
        /* Visual Chart Styles */
        .visual-chart-container {
            margin-top: 15px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .chart-title {
            font-size: 0.85em;
            color: #00d4ff;
            margin-bottom: 10px;
            font-weight: 600;
            text-align: center;
        }
        .mini-chart {
            width: 100%;
            height: 80px;
            border-radius: 4px;
        }
        .chart-legend {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 0.75em;
            color: #888;
        }
        
        /* Asset Comparison Cards */
        .asset-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .asset-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .asset-name {
            font-size: 1.2em;
            font-weight: 600;
        }
        .asset-price {
            font-size: 1.4em;
            font-weight: 700;
        }
        .asset-change {
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        /* Colors */
        .extreme-fear { color: #ff4757; }
        .fear { color: #ff6b6b; }
        .neutral { color: #ffa502; }
        .greed { color: #26de81; }
        .bullish { color: #26de81; }
        .bearish { color: #ff4757; }
        .mid-risk { color: #ffa502; }
        .low-risk { color: #26de81; }
        .high-risk { color: #ff6b6b; }
        .critical-risk { color: #ff4757; }
        
        /* Badges */
        .status-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
        }
        .badge-golden-cross {
            background: rgba(38, 222, 129, 0.3);
            color: #26de81;
            border: 2px solid #26de81;
            box-shadow: 0 0 20px rgba(38, 222, 129, 0.3);
        }
        .badge-death-cross {
            background: rgba(255, 71, 87, 0.3);
            color: #ff4757;
            border: 2px solid #ff4757;
            box-shadow: 0 0 20px rgba(255, 71, 87, 0.3);
        }
        .badge-critical-risk {
            background: rgba(255, 71, 87, 0.3);
            color: #ff4757;
            border: 2px solid #ff4757;
        }
        .badge-high-risk {
            background: rgba(255, 107, 107, 0.3);
            color: #ff6b6b;
            border: 2px solid #ff6b6b;
        }
        .badge-mid-risk {
            background: rgba(255, 165, 2, 0.2);
            color: #ffa502;
            border: 2px solid #ffa502;
        }
        .badge-low-risk {
            background: rgba(38, 222, 129, 0.2);
            color: #26de81;
            border: 2px solid #26de81;
        }
        .ai-badge {
            background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.65em;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        
        /* AI Insight in Cards */
        .card-ai-insight {
            font-size: 0.85em;
            color: #aaa;
            margin: 15px 0;
            padding: 10px;
            background: rgba(0, 212, 255, 0.05);
            border-left: 3px solid #00d4ff;
            border-radius: 4px;
            line-height: 1.6;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .card-ai-insight::before {
            content: 'ü§ñ';
            font-size: 1.2em;
            align-self: flex-start;
        }

        /* Detailed Analysis */
        .summary-box {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            border: 1px solid rgba(255, 165, 2, 0.3);
            padding: 25px;
            margin-bottom: 30px;
            line-height: 1.8;
        }
        .detailed-analysis-header {
            color: #ffa502;
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 20px;
            text-align: center;
            padding: 15px;
            border-bottom: 2px solid rgba(255, 165, 2, 0.3);
        }
        .analysis-section {
            margin-bottom: 20px;
        }
        .analysis-section:last-child {
            margin-bottom: 0;
        }
        .section-title {
            color: #00d4ff;
            font-weight: 600;
            font-size: 1.05em;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .section-icon {
            font-size: 1.2em;
        }
        .section-content {
            color: #e0e0e0;
            font-size: 0.95em;
            line-height: 1.7;
            padding-left: 28px;
        }
        .highlight {
            color: #ffa502;
            font-weight: 600;
        }
        .key-level {
            background: rgba(255, 165, 2, 0.15);
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
        }
        .large-value { font-size: 3em; font-weight: 700; text-align: center; margin: 20px 0; }
        .trend-arrow { font-size: 1.2em; margin-left: 5px; }
        
        /* Glossary Section */
        .glossary-section {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 15px;
            padding: 40px;
            margin-top: 40px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .glossary-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 2px solid rgba(0, 212, 255, 0.3);
        }
        .glossary-icon {
            font-size: 2em;
        }
        .glossary-header h2 {
            font-size: 2em;
            font-weight: 700;
            background: linear-gradient(45deg, #00d4ff, #0099ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 0;
        }
        .glossary-intro {
            font-size: 1.1em;
            line-height: 1.8;
            color: #ccc;
            margin-bottom: 40px;
            padding: 20px;
            background: rgba(0, 212, 255, 0.05);
            border-left: 4px solid #00d4ff;
            border-radius: 8px;
        }
        .glossary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        .glossary-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .glossary-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 212, 255, 0.15);
            border-color: rgba(0, 212, 255, 0.3);
        }
        .glossary-card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }
        .glossary-emoji {
            font-size: 1.8em;
        }
        .glossary-card-header h3 {
            font-size: 1.3em;
            font-weight: 600;
            color: #00d4ff;
            margin: 0;
        }
        .glossary-content {
            color: #e0e0e0;
            line-height: 1.7;
        }
        .glossary-content p {
            margin-bottom: 15px;
        }
        .glossary-content strong {
            color: #fff;
            font-weight: 600;
        }
        .glossary-content ul {
            margin: 10px 0 15px 20px;
            padding: 0;
        }
        .glossary-content li {
            margin-bottom: 8px;
            line-height: 1.6;
        }
        .glossary-content ul ul {
            margin-top: 8px;
            margin-left: 20px;
        }
        .risk-label {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.9em;
        }
        .risk-label.low {
            background: rgba(38, 222, 129, 0.2);
            color: #26de81;
            border: 1px solid #26de81;
        }
        .risk-label.moderate {
            background: rgba(255, 165, 2, 0.2);
            color: #ffa502;
            border: 1px solid #ffa502;
        }
        .risk-label.high {
            background: rgba(255, 107, 107, 0.2);
            color: #ff6b6b;
            border: 1px solid #ff6b6b;
        }
        .risk-label.critical {
            background: rgba(255, 71, 87, 0.3);
            color: #ff4757;
            border: 1px solid #ff4757;
        }
        .vix-level, .fg-level {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 5px;
            font-weight: 600;
            font-size: 0.9em;
        }
        .vix-level.low, .fg-level.greed, .fg-level.extreme-greed {
            background: rgba(38, 222, 129, 0.2);
            color: #26de81;
        }
        .vix-level.normal, .fg-level.neutral {
            background: rgba(255, 165, 2, 0.2);
            color: #ffa502;
        }
        .vix-level.elevated, .fg-level.fear {
            background: rgba(255, 107, 107, 0.2);
            color: #ff6b6b;
        }
        .vix-level.high, .vix-level.extreme, .fg-level.extreme-fear {
            background: rgba(255, 71, 87, 0.2);
            color: #ff4757;
        }
        .glossary-footer {
            margin-top: 40px;
            padding: 25px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            border: 1px solid rgba(255, 165, 2, 0.2);
        }
        .glossary-footer p {
            margin-bottom: 15px;
            line-height: 1.7;
            color: #aaa;
            font-size: 0.9em;
        }
        .glossary-footer p:last-child {
            margin-bottom: 0;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .glossary-grid {
                grid-template-columns: 1fr;
            }
            .glossary-section {
                padding: 25px 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-logo">
                <div class="logo-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="3 17 9 11 13 15 21 7"></polyline>
                        <polyline points="14 7 21 7 21 14"></polyline>
                    </svg>
                </div>
            </div>
            <h1>Market Risk Monitor</h1>
            <div class="header-subtitle">Real-Time Market Intelligence Dashboard</div>
            <div class="header-disclaimer">
                <strong>Focus:</strong> Growth Tech Stocks (QQQ/Nasdaq-100) | 
                <strong>Purpose:</strong> Risk monitoring and technical analysis for informational purposes only. Not financial advice.
            </div>
            <nav class="navigation">
                <a id="nav-dashboard" class="nav-link active">Dashboard</a>
                <a id="nav-glossary" class="nav-link">Glossary</a>
            </nav>
        </div>

        <div id="app-content">
            <!-- Loading and Error states -->
            <div id="loading" class="loading">Loading market data...</div>
            <div id="error" class="error" style="display: none;"></div>

            <!-- Dashboard Page -->
            <div id="page-dashboard" style="display: none;">
                <div class="last-updated" id="lastUpdated">Last Updated: ...</div>
    
                <div class="exec-summary">
                    <div class="exec-summary-header">
                        <span>üìã</span>
                        Executive Summary
                        <span class="tldr-badge">TL;DR</span>
                    </div>
                    <div class="exec-summary-content" id="execSummary"></div>
                </div>
                
                <div class="risk-meter-container">
                    <div class="risk-meter-title">üéØ Composite Risk Score</div>
                    <div class="risk-meter">
                        <div class="risk-meter-fill" id="riskMeterFill"></div>
                        <div class="risk-meter-label" id="riskMeterLabel"></div>
                    </div>
                    <div class="risk-breakdown" id="riskBreakdown"></div>
                </div>
                
                <div class="multi-asset-section">
                    <div class="section-header">üåê Multi-Asset Overview</div>
                    <div class="dashboard" id="multiAssetGrid"></div>
                </div>
                
                <div class="multi-asset-section">
                    <div class="section-header">üìà QQQ Detailed Metrics</div>
                    <div class="dashboard">
                        <div class="card">
                            <div class="card-title">Advanced Risk Assessment</div>
                            <div class="card-subtitle">Multi-factor algorithmic risk evaluation</div>
                            <div style="text-align: center; margin: 15px 0;" id="riskBadgeContainer"></div>
                            <div class="card-ai-insight" id="riskCardInsightContainer" style="display:none;">
                                <span id="riskCardInsight"></span>
                            </div>
                            <div class="trend-mini" id="vixTrend"></div>
                        </div>
                        
                        <div class="card">
                            <div class="card-title">Golden/Death Cross Analysis</div>
                            <div class="card-subtitle">21-Day vs 50-Day MA crossover</div>
                            <div style="text-align: center; margin: 15px 0;" id="crossBadgeContainer"></div>
                            <div class="card-ai-insight" id="momentumCardInsightContainer" style="display:none;">
                                <span id="momentumCardInsight"></span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">Short-term Trend (21 vs 50)</span>
                                <span class="metric-value" id="crossTrendValue">--</span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">QQQ Distance from 50MA</span>
                                <span class="metric-value" id="qqq50maMain">--</span>
                            </div>
                            <div class="trend-mini" id="maTrend"></div>
                        </div>
                        
                        <div class="card">
                            <div class="card-title">QQQ Moving Averages</div>
                            <div class="card-subtitle">Price relative to key MAs</div>
                            <div class="metric">
                                <span class="metric-label">Current Price</span>
                                <span class="metric-value" id="qqqPrice">--</span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">21-Day MA</span>
                                <span class="metric-value" id="qqq21">--</span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">50-Day MA</span>
                                <span class="metric-value" id="qqq50">--</span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">21 vs 50 Trend</span>
                                <span class="metric-value" id="ma21vs50">--</span>
                            </div>
                            <div class="trend-mini" id="priceTrend"></div>
                        </div>
                        
                        <div class="card">
                            <div class="card-title">Market Sentiment & Volatility</div>
                            <div class="card-subtitle">Fear indicators and sentiment composite</div>
                            <div class="metric">
                                <span class="metric-label">VIX (Fear Index)</span>
                                <span class="metric-value" id="vixEod">--</span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">VIX 10-Day MA</span>
                                <span class="metric-value" id="vix10ma">--</span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">VIX vs 10-Day Avg</span>
                                <span class="metric-value" id="vixVs10d">--</span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">CNN Fear & Greed</span>
                                <span class="metric-value" id="fearGreedValue">--</span>
                            </div>
                            <div style="text-align: center; margin: 15px 0;" id="fearGreedBadgeContainer"></div>
                            <div class="trend-mini" id="fearGreedTrend"></div>
                        </div>
                    </div>
                </div>
                
                <div class="multi-asset-section">
                    <div class="section-header">üìà 5-Day Trend Analysis</div>
                    <div class="dashboard">
                        <div class="card">
                            <div class="visual-chart-container">
                                <div class="chart-title">QQQ Price Movement</div>
                                <canvas id="qqqChart" class="mini-chart"></canvas>
                                <div class="chart-legend">
                                    <span id="qqqChartMin">--</span>
                                    <span id="qqqChartCurrent" style={{color: '#00d4ff', fontWeight: 600}}>Current: --</span>
                                    <span id="qqqChartMax">--</span>
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="visual-chart-container">
                                <div class="chart-title">21MA vs 50MA Spread</div>
                                <canvas id="maChart" class="mini-chart"></canvas>
                                <div class="chart-legend">
                                    <span id="maChartMin">--</span>
                                    <span id="maChartCurrent" style={{color: '#00d4ff', fontWeight: 600}}>Current: --</span>
                                    <span id="maChartMax">--</span>
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="visual-chart-container">
                                <div class="chart-title">Fear & Greed Index</div>
                                <canvas id="fgChart" class="mini-chart"></canvas>
                                <div class="chart-legend">
                                    <span id="fgChartMin">--</span>
                                    <span id="fgChartCurrent" style={{color: '#00d4ff', fontWeight: 600}}>Current: --</span>
                                    <span id="fgChartMax">--</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="summary-box">
                    <div class="detailed-analysis-header">
                        üìä Detailed Market Analysis
                        <span class="ai-badge" style="margin-left: 10px;">GEMINI AI</span>
                    </div>
                    <div id="detailedAnalysis"></div>
                </div>
            </div>

            <!-- Glossary Page -->
            <div id="page-glossary" style="display: none;">
                 <div class="glossary-section">
                    <div class="glossary-header">
                        <span class="glossary-icon">üìö</span>
                        <h2>Methodology & Intelligence Glossary</h2>
                    </div>
                    
                    <div class="glossary-intro">
                        This dashboard combines multiple technical indicators, sentiment analysis, and AI-powered insights to provide comprehensive market risk assessment. Below is a detailed explanation of all metrics, calculations, and intelligence systems.
                    </div>
                    
                    <div class="glossary-grid">
                        {/* Risk Score Meter */}
                        <div class="glossary-card">
                            <div class="glossary-card-header">
                                <span class="glossary-emoji">üéØ</span>
                                <h3>Composite Risk Score (0-100)</h3>
                            </div>
                            <div class="glossary-content">
                                <p><strong>What it is:</strong> A proprietary algorithm that combines four key market risk factors into a single, easy-to-understand score.</p>
                                
                                <p><strong>Calculation:</strong></p>
                                <ul>
                                    <li><strong>VIX Component (0-30 points):</strong>
                                        <ul>
                                            <li>VIX 10MA ‚â•30: 30 points (Critical volatility)</li>
                                            <li>VIX 10MA ‚â•25: 22 points (High volatility)</li>
                                            <li>VIX 10MA ‚â•20: 15 points (Elevated volatility)</li>
                                            <li>VIX 10MA &lt;20: 5 points (Normal volatility)</li>
                                        </ul>
                                    </li>
                                    <li><strong>Price Position Component (0-25 points):</strong>
                                        <ul>
                                            <li>Below both 21MA & 50MA: 25 points (Weak trend)</li>
                                            <li>Below 21MA only: 15 points (Short-term weakness)</li>
                                            <li>Below 50MA only: 10 points (Mid-term weakness)</li>
                                            <li>Above all MAs: 0 points (Strong trend)</li>
                                        </ul>
                                    </li>
                                    <li><strong>Momentum Component (0-20 points):</strong>
                                        <ul>
                                            <li>Death Cross (21MA &lt; 50MA): 20 points (Bearish)</li>
                                            <li>Weak Golden Cross (&lt;1% gap): 10 points (Neutral)</li>
                                            <li>Strong Golden Cross: 0 points (Bullish)</li>
                                        </ul>
                                    </li>
                                    <li><strong>Sentiment Component (0-25 points):</strong>
                                        <ul>
                                            <li>Extreme Fear (‚â§25): 20 points (Oversold conditions)</li>
                                            <li>Fear (‚â§45): 12 points (Cautious sentiment)</li>
                                            <li>Extreme Greed (‚â•75): 15 points (Overbought conditions)</li>
                                            <li>Neutral: 5 points (Balanced sentiment)</li>
                                        </ul>
                                    </li>
                                </ul>
                                
                                <p><strong>Interpretation:</strong></p>
                                <ul>
                                    <li><span class="risk-label low">0-25: LOW RISK</span> - Favorable conditions for deploying capital</li>
                                    <li><span class="risk-label moderate">26-50: MODERATE RISK</span> - Proceed with caution, consider scaling positions</li>
                                    <li><span class="risk-label high">51-75: HIGH RISK</span> - Reduce exposure, focus on preservation</li>
                                    <li><span class="risk-label critical">76-100: CRITICAL RISK</span> - Defensive positioning recommended</li>
                                </ul>
                            </div>
                        </div>
                        
                        {/* Moving Averages */}
                        <div class="glossary-card">
                            <div class="glossary-card-header">
                                <span class="glossary-emoji">üìà</span>
                                <h3>Moving Averages (MA)</h3>
                            </div>
                            <div class="glossary-content">
                                <p><strong>What they are:</strong> Statistical calculations that smooth price data by creating a constantly updated average price over specific time periods.</p>
                                
                                <p><strong>21-Day Moving Average (21MA):</strong></p>
                                <ul>
                                    <li>Short-term trend indicator</li>
                                    <li>More responsive to recent price changes</li>
                                    <li>Used for tactical entry/exit points</li>
                                    <li>Formula: Sum of last 21 closing prices √∑ 21</li>
                                </ul>
                                
                                <p><strong>50-Day Moving Average (50MA):</strong></p>
                                <ul>
                                    <li>Intermediate-term trend indicator</li>
                                    <li>Less sensitive to daily volatility</li>
                                    <li>Key support/resistance level</li>
                                    <li>Formula: Sum of last 50 closing prices √∑ 50</li>
                                </ul>
                                
                                <p><strong>Price vs MA Distance:</strong></p>
                                <ul>
                                    <li>Calculated as: (Current Price - MA) / MA √ó 100</li>
                                    <li>Positive % = Price above MA (bullish)</li>
                                    <li>Negative % = Price below MA (bearish)</li>
                                    <li>Extreme values (&gt;5% or &lt;-5%) suggest overextension</li>
                                </ul>
                            </div>
                        </div>
                        
                        {/* Golden/Death Cross */}
                        <div class="glossary-card">
                            <div class="glossary-card-header">
                                <span class="glossary-emoji">‚ö°</span>
                                <h3>Golden Cross / Death Cross</h3>
                            </div>
                            <div class="glossary-content">
                                <p><strong>What it is:</strong> A powerful momentum indicator based on the relationship between short-term (21-day) and intermediate-term (50-day) moving averages.</p>
                                
                                <p><strong>Golden Cross (Bullish):</strong></p>
                                <ul>
                                    <li>Occurs when 21MA crosses above 50MA</li>
                                    <li>Signals shift to upward momentum</li>
                                    <li>Historically precedes sustained rallies</li>
                                    <li>Confirmation: 21MA should be &gt;1% above 50MA</li>
                                </ul>
                                
                                <p><strong>Death Cross (Bearish):</strong></p>
                                <ul>
                                    <li>Occurs when 21MA crosses below 50MA</li>
                                    <li>Signals shift to downward momentum</li>
                                    <li>Warning of potential trend reversal</li>
                                    <li>Historically precedes market corrections</li>
                                </ul>
                                
                                <p><strong>Dashboard Metric (21MA vs 50MA %):</strong></p>
                                <ul>
                                    <li>Positive value: Golden Cross territory</li>
                                    <li>Negative value: Death Cross territory</li>
                                    <li>Magnitude shows strength of trend</li>
                                    <li>Formula: (21MA - 50MA) / 50MA √ó 100</li>
                                </ul>
                            </div>
                        </div>
                        
                        {/* VIX */}
                        <div class="glossary-card">
                            <div class="glossary-card-header">
                                <span class="glossary-emoji">üí•</span>
                                <h3>VIX (Volatility Index)</h3>
                            </div>
                            <div class="glossary-content">
                                <p><strong>What it is:</strong> The CBOE Volatility Index, often called the "Fear Index," measures the market's expectation of 30-day forward volatility based on S&P 500 options pricing.</p>
                                
                                <p><strong>Interpretation Levels:</strong></p>
                                <ul>
                                    <li><strong>&lt;15:</strong> <span class="vix-level low">Low volatility</span> - Complacency, potential for surprise moves</li>
                                    <li><strong>15-20:</strong> <span class="vix-level normal">Normal range</span> - Typical market conditions</li>
                                    <li><strong>20-30:</strong> <span class="vix-level elevated">Elevated</span> - Increased uncertainty, cautious positioning</li>
                                    <li><strong>30-40:</strong> <span class="vix-level high">High</span> - Significant fear, potential opportunities</li>
                                    <li><strong>&gt;40:</strong> <span class="vix-level extreme">Extreme panic</span> - Historical buying opportunities</li>
                                </ul>
                                
                                <p><strong>VIX 10-Day Moving Average:</strong></p>
                                <ul>
                                    <li>Smooths daily VIX fluctuations</li>
                                    <li>Better gauge of sustained volatility trends</li>
                                    <li>Used in risk score calculation</li>
                                </ul>
                                
                                <p><strong>VIX vs 10-Day Average:</strong></p>
                                <ul>
                                    <li>Shows if current fear is increasing or decreasing</li>
                                    <li>Positive % = Fear rising (volatility spike)</li>
                                    <li>Negative % = Fear subsiding (calm returning)</li>
                                </ul>
                            </div>
                        </div>
                        
                        {/* Fear & Greed */}
                        <div class="glossary-card">
                            <div class="glossary-card-header">
                                <span class="glossary-emoji">üé≠</span>
                                <h3>CNN Fear & Greed Index</h3>
                            </div>
                            <div class="glossary-content">
                                <p><strong>What it is:</strong> A composite sentiment indicator that measures investor emotion and behavior across seven different market factors.</p>
                                
                                <p><strong>Seven Components:</strong></p>
                                <ul>
                                    <li><strong>Market Momentum:</strong> S&P 500 vs 125-day MA</li>
                                    <li><strong>Stock Price Strength:</strong> Stocks at 52-week highs vs lows</li>
                                    <li><strong>Stock Price Breadth:</strong> NYSE advancing vs declining volume</li>
                                    <li><strong>Put/Call Options:</strong> Put volume vs call volume ratio</li>
                                    <li><strong>Market Volatility:</strong> VIX levels</li>
                                    <li><strong>Safe Haven Demand:</strong> Stocks vs Treasury bonds</li>
                                    <li><strong>Junk Bond Demand:</strong> Spread between junk bonds and Treasuries</li>
                                </ul>
                                
                                <p><strong>Scale (0-100):</strong></p>
                                <ul>
                                    <li><strong>0-25:</strong> <span class="fg-level extreme-fear">Extreme Fear</span> - Potential buying opportunity</li>
                                    <li><strong>26-45:</strong> <span class="fg-level fear">Fear</span> - Cautious sentiment, oversold conditions possible</li>
                                    <li><strong>46-55:</strong> <span class="fg-level neutral">Neutral</span> - Balanced market sentiment</li>
                                    <li><strong>56-75:</strong> <span class="fg-level greed">Greed</span> - Optimistic sentiment, overbought conditions possible</li>
                                    <li><strong>76-100:</strong> <span class="fg-level extreme-greed">Extreme Greed</span> - Potential warning sign, consider profit-taking</li>
                                </ul>
                                
                                <p><strong>Contrarian Indicator:</strong></p>
                                <ul>
                                    <li>Extreme Fear often precedes market bottoms</li>
                                    <li>Extreme Greed often precedes market tops</li>
                                    <li>Works best at extremes (&lt;20 or &gt;80)</li>
                                </ul>
                            </div>
                        </div>
                        
                        {/* Historical Trends */}
                        <div class="glossary-card">
                            <div class="glossary-card-header">
                                <span class="glossary-emoji">üìä</span>
                                <h3>5-Day Historical Trends</h3>
                            </div>
                            <div class="glossary-content">
                                <p><strong>What it is:</strong> Automated tracking of key metrics over the last 5 trading days to visualize momentum and trend direction.</p>
                                
                                <p><strong>Data Collection (AppScript):</strong></p>
                                <ul>
                                    <li>Runs automatically daily at 4:30 PM ET (after market close)</li>
                                    <li>Captures: QQQ price, VIX, 21MA vs 50MA spread, Fear & Greed</li>
                                    <li>Stores in "Historical_Data" sheet</li>
                                    <li>Maintains rolling 5-day window</li>
                                    <li>Data shifts daily: Day 5‚ÜíDay 4, Day 4‚ÜíDay 3, etc.</li>
                                </ul>
                                
                                <p><strong>Visual Charts:</strong></p>
                                <ul>
                                    <li><strong>Green gradient:</strong> Uptrend (latest value &gt; oldest value)</li>
                                    <li><strong>Red gradient:</strong> Downtrend (latest value &lt; oldest value)</li>
                                    <li>Shows Min/Current/Max labels for context</li>
                                    <li>Helps identify momentum shifts before they become obvious</li>
                                </ul>
                                
                                <p><strong>Why 5 Days?</strong></p>
                                <ul>
                                    <li>Captures full trading week</li>
                                    <li>Removes weekend noise</li>
                                    <li>Shows short-term momentum without excessive lag</li>
                                    <li>Complements longer-term moving averages</li>
                                </ul>
                            </div>
                        </div>
                        
                        {/* Multi-Asset Dashboard */}
                        <div class="glossary-card">
                            <div class="glossary-card-header">
                                <span class="glossary-emoji">üåê</span>
                                <h3>Multi-Asset Comparison</h3>
                            </div>
                            <div class="glossary-content">
                                <p><strong>What it is:</strong> Simultaneous tracking of multiple asset classes to identify sector rotation, risk-on/risk-off behavior, and relative performance.</p>
                                
                                <p><strong>Assets Tracked:</strong></p>
                                <ul>
                                    <li><strong>QQQ (Invesco QQQ Trust):</strong>
                                        <ul>
                                            <li>Tracks Nasdaq-100 Index</li>
                                            <li>Technology and growth focus</li>
                                            <li>Higher volatility, higher return potential</li>
                                            <li>Primary focus of this dashboard</li>
                                        </ul>
                                    </li>
                                    <li><strong>SPY (SPDR S&P 500 ETF):</strong>
                                        <ul>
                                            <li>Tracks S&P 500 Index</li>
                                            <li>Broad market benchmark</li>
                                            <li>More diversified than QQQ</li>
                                            <li>Compare to see if tech outperforming/underperforming</li>
                                        </ul>
                                    </li>
                                    <li><strong>TLT (iShares 20+ Year Treasury Bond ETF):</strong>
                                        <ul>
                                            <li>Long-duration US Treasury bonds</li>
                                            <li>Safe-haven asset</li>
                                            <li>Inverse correlation to stocks in risk-off environments</li>
                                            <li>Rising TLT + falling stocks = flight to safety</li>
                                        </ul>
                                    </li>
                                    <li><strong>GLD (SPDR Gold Shares):</strong>
                                        <ul>
                                            <li>Physical gold holdings</li>
                                            <li>Inflation hedge</li>
                                            <li>Alternative safe-haven to bonds</li>
                                            <li>Rising GLD can signal inflation concerns or uncertainty</li>
                                        </ul>
                                    </li>
                                </ul>
                                
                                <p><strong>Rotation Signals:</strong></p>
                                <ul>
                                    <li><strong>Risk-On:</strong> QQQ‚Üë, SPY‚Üë, TLT‚Üì, GLD‚Üì (investors seeking returns)</li>
                                    <li><strong>Risk-Off:</strong> QQQ‚Üì, SPY‚Üì, TLT‚Üë, GLD‚Üë (investors seeking safety)</li>
                                    <li><strong>Tech Rotation:</strong> QQQ outperforming SPY significantly</li>
                                    <li><strong>Value Rotation:</strong> SPY outperforming QQQ significantly</li>
                                </ul>
                            </div>
                        </div>
                        
                        {/* AI Analysis */}
                        <div class="glossary-card">
                            <div class="glossary-card-header">
                                <span class="glossary-emoji">ü§ñ</span>
                                <h3>AI-Powered Analysis (Gemini)</h3>
                            </div>
                            <div class="glossary-content">
                                <p><strong>What it is:</strong> Real-time market analysis powered by Google's Gemini AI, combining all dashboard metrics into actionable insights.</p>
                                
                                <p><strong>Analysis Process:</strong></p>
                                <ul>
                                    <li><strong>Data Input:</strong> All current metrics (price, MAs, VIX, sentiment, risk score, cross status)</li>
                                    <li><strong>Context Integration:</strong> Historical trends, market conditions, volatility environment</li>
                                    <li><strong>Pattern Recognition:</strong> Identifies setups similar to past market conditions</li>
                                    <li><strong>Risk Assessment:</strong> Evaluates current risk/reward profile</li>
                                    <li><strong>Strategic Output:</strong> Provides market positioning guidance in a structured JSON format.</li>
                                </ul>
                                
                                <p><strong>Analysis Structure:</strong></p>
                                <ul>
                                    <li><strong>Executive Summary:</strong> High-level stance and opportunity assessment.</li>
                                    <li><strong>Card-Specific Insights:</strong> Concise, one-sentence summaries for Risk and Momentum cards.</li>
                                    <li><strong>Detailed Breakdown:</strong> In-depth analysis of conditions, risks, and opportunities.</li>
                                </ul>
                                
                                <p><strong>Update Frequency:</strong></p>
                                <ul>
                                    <li>Refreshes hourly with market data</li>
                                    <li>Adapts to changing market conditions in real-time</li>
                                    <li>Provides consistent framework for decision-making</li>
                                </ul>
                            </div>
                        </div>
                        
                        {/* Data Sources */}
                        <div class="glossary-card">
                            <div class="glossary-card-header">
                                <span class="glossary-emoji">üîó</span>
                                <h3>Data Sources & Updates</h3>
                            </div>
                            <div class="glossary-content">
                                <p><strong>Data Providers:</strong></p>
                                <ul>
                                    <li><strong>Google Finance:</strong> Real-time stock prices, moving averages (via Google Sheets formulas)</li>
                                    <li><strong>CBOE:</strong> VIX data (Chicago Board Options Exchange)</li>
                                    <li><strong>CNN Business:</strong> Fear & Greed Index composite data</li>
                                    <li><strong>Historical Data:</strong> Google Apps Script automated collection</li>
                                </ul>
                                
                                <p><strong>Update Schedule:</strong></p>
                                <ul>
                                    <li><strong>Live Data:</strong> Refreshes every hour during market hours</li>
                                    <li><strong>Historical Data:</strong> Updates daily at 4:30 PM ET</li>
                                    <li><strong>AI Analysis:</strong> Regenerates with each data refresh</li>
                                    <li><strong>Multi-Asset Data:</strong> Updates hourly</li>
                                </ul>
                                
                                <p><strong>Data Pipeline:</strong></p>
                                <ul>
                                    <li>Google Sheets ‚Üí Published CSV ‚Üí Dashboard frontend</li>
                                    <li>Dashboard ‚Üí Google Gemini API ‚Üí AI Analysis</li>
                                </ul>
                                
                                <p><strong>Reliability:</strong></p>
                                <ul>
                                    <li>Multiple redundant data sources</li>
                                    <li>Automatic error handling and fallbacks</li>
                                    <li>Console logging for troubleshooting</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <div class="glossary-footer">
                        <p><strong>Disclaimer:</strong> This dashboard provides educational and informational content only. All metrics, analyses, and AI-generated insights are for research purposes and should not be considered financial advice. Past performance does not guarantee future results. Always conduct your own due diligence and consult with qualified financial professionals before making investment decisions. Market conditions can change rapidly, and no indicator or system is foolproof.</p>
                        
                        <p><strong>Technical Stack:</strong> HTML5, CSS3, JavaScript (ESM), Google Sheets, Google Apps Script, Google Gemini API</p>
                        
                        <p><strong>Version:</strong> 3.1 Single-File Edition | <strong>Last Updated:</strong> November 2024</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script type="module">
        import { GoogleGenAI, Type } from "@google/genai";

        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ9zKKjsxivMTlhDdAnsf3py3xCQZfZbcZtdV20FFKGwEpJXzIofIk-qYWDCCw1eP5QMOjNfQpB5wLH/pub?gid=2141065289&single=true&output=csv';
        const HISTORICAL_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ9zKKjsxivMTlhDdAnsf3py3xCQZfZbcZtdV20FFKGwEpJXzIofIk-qYWDCCw1eP5QMOjNfQpB5wLH/pub?gid=192889417&single=true&output=csv';

        // --- Helper Functions ---
        function getTrendArrow(v) { return v > 0 ? ' ‚Üë' : v < 0 ? ' ‚Üì' : ''; }
        function getColorClass(v, t) {
            if (t === 'vix') return v < 20 ? 'neutral' : v < 30 ? 'fear' : 'extreme-fear';
            return v > 0 ? 'bullish' : 'bearish';
        }
        function getFearGreedStatus(v) {
            if (v <= 25) return { text: 'EXTREME FEAR', class: 'badge-critical-risk' };
            if (v <= 45) return { text: 'FEAR', class: 'badge-high-risk' };
            if (v <= 55) return { text: 'NEUTRAL', class: 'badge-mid-risk' };
            if (v <= 75) return { text: 'GREED', class: 'badge-low-risk' };
            return { text: 'EXTREME GREED', class: 'badge-low-risk' };
        }

        // --- Data Calculation ---
        function calculateRiskScore(data) {
            let score = 0;
            const factors = {
                vix: { score: 0, label: '' },
                position: { score: 0, label: '' },
                momentum: { score: 0, label: '' },
                sentiment: { score: 0, label: '' },
            };

            const vix10 = data.vix10ma;
            if (vix10 >= 30) { score += 30; factors.vix = { score: 30, label: 'Critical' }; }
            else if (vix10 >= 25) { score += 22; factors.vix = { score: 22, label: 'High' }; }
            else if (vix10 >= 20) { score += 15; factors.vix = { score: 15, label: 'Elevated' }; }
            else { score += 5; factors.vix = { score: 5, label: 'Low' }; }

            const { qqq21ma, qqq50ma } = data;
            if (qqq21ma < 0 && qqq50ma < 0) { score += 25; factors.position = { score: 25, label: 'Below All MAs' }; }
            else if (qqq21ma < 0) { score += 15; factors.position = { score: 15, label: 'Below 21MA' }; }
            else if (qqq50ma < 0) { score += 10; factors.position = { score: 10, label: 'Below 50MA' }; }
            else { factors.position = { score: 0, label: 'Above MAs' }; }

            const { ma21vs50 } = data;
            if (ma21vs50 < 0) { score += 20; factors.momentum = { score: 20, label: 'Death Cross' }; }
            else if (ma21vs50 < 1) { score += 10; factors.momentum = { score: 10, label: 'Weak Golden' }; }
            else { factors.momentum = { score: 0, label: 'Golden Cross' }; }

            const fg = data.fearGreed;
            if (fg <= 25) { score += 20; factors.sentiment = { score: 20, label: 'Extreme Fear' }; }
            else if (fg <= 45) { score += 12; factors.sentiment = { score: 12, label: 'Fear' }; }
            else if (fg >= 75) { score += 15; factors.sentiment = { score: 15, label: 'Extreme Greed' }; }
            else { score += 5; factors.sentiment = { score: 5, label: 'Neutral' }; }

            return { score, factors, max: 100 };
        }

        // --- Data Fetching ---
        async function loadHistoricalData() {
            const historicalData = { vix: [], qqq: [], ma21vs50: [], fearGreed: [] };
            if (!HISTORICAL_CSV_URL) return historicalData;

            try {
                const res = await fetch(HISTORICAL_CSV_URL);
                if (!res.ok) throw new Error('Failed to fetch historical CSV');
                const csv = await res.text();
                const rows = csv.split('\n').map(r => r.split(',').map(c => c.trim().replace(/"/g, '')));
                
                if (rows.length >= 5) {
                    historicalData.qqq = rows[1]?.slice(1, 6).map(v => parseFloat(v)).filter(v => !isNaN(v)) || [];
                    historicalData.vix = rows[2]?.slice(1, 6).map(v => parseFloat(v)).filter(v => !isNaN(v)) || [];
                    historicalData.ma21vs50 = rows[3]?.slice(1, 6).map(v => parseFloat(v)).filter(v => !isNaN(v)) || [];
                    historicalData.fearGreed = rows[4]?.slice(1, 6).map(v => parseFloat(v)).filter(v => !isNaN(v)) || [];
                }
                return historicalData;
            } catch (e) {
                console.error('Error loading historical data:', e);
                return historicalData;
            }
        }

        async function fetchMultiAssetData() {
            return {
                SPY: { price: 580.45, change: 0.45, change_pct: 0.08, ma21: 575.20, ma50: 568.30 },
                TLT: { price: 92.15, change: -0.32, change_pct: -0.35, ma21: 92.80, ma50: 93.50 },
                GLD: { price: 245.67, change: 1.23, change_pct: 0.50, ma21: 244.10, ma50: 242.80 }
            };
        }

        function formatDetailedSections(markdownText) {
            const sections = {};
            let currentSection = null;
            
            const lines = markdownText.split('\n');
            
            for (const line of lines) {
                const trimmedLine = line.trim();
                const match = trimmedLine.match(/^\*\*(.*?):\*\*/);
                if (match && match[1]) {
                    currentSection = match[1];
                    sections[currentSection] = [];
                } else if (currentSection && trimmedLine.length > 0) {
                    sections[currentSection].push(trimmedLine);
                }
            }
            
            const sectionMap = {
                'Current Market Conditions': { icon: 'üìà', title: 'Current Market Conditions' },
                'Risk Assessment': { icon: '‚ö†Ô∏è', title: 'Risk Assessment' },
                'Strategic Opportunities': { icon: 'üí°', title: 'Strategic Opportunities' },
                'Positioning Recommendations': { icon: 'üéØ', title: 'Action Items' },
            };

            let html = '';
            for (const key in sections) {
                const sectionConfig = sectionMap[key];
                if (sectionConfig && sections[key].length > 0) {
                    html += `<div class="analysis-section"><div class="section-title"><span class="section-icon">${sectionConfig.icon}</span>${sectionConfig.title}</div><div class="section-content">`;
                    html += sections[key].map(line => {
                        return line
                            .replace(/^\* /, '‚Ä¢ ')
                            .replace(/\$(\d+(\.\d+)?)/g, '<span class="key-level">$$$1</span>')
                            .replace(/([\+\-]\d+\.?\d*%)/g, '<span class="highlight">$1</span>');
                    }).join('<br>');
                    html += '</div></div>';
                }
            }
            return html;
        }

        async function getAIAnalysis(data) {
            try {
                const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });

                const prompt = `
                    You are a professional market analyst for a high-tech financial dashboard. Your focus is on QQQ (Nasdaq-100) and growth tech stocks.
                    Analyze the following real-time market data and provide a concise, actionable analysis as a JSON object matching the provided schema.

                    **Current Data:**
                    - QQQ Price: ${data.qqqPrice.toFixed(2)}
                    - Price vs 21MA: ${data.qqq21ma.toFixed(2)}%
                    - Price vs 50MA: ${data.qqq50ma.toFixed(2)}%
                    - 21MA vs 50MA Spread: ${data.ma21vs50.toFixed(2)}%
                    - Golden/Death Cross Status: ${data.crossStatus}
                    - VIX (Fear Index): ${data.vixEod.toFixed(2)}
                    - CNN Fear & Greed Index: ${data.fearGreed}
                    - Composite Risk Level: ${data.riskLevel}

                    Generate the full JSON output based on this data.
                `;
                
                const response = await ai.models.generateContent({
                    model: 'gemini-2.5-flash',
                    contents: prompt,
                    config: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: Type.OBJECT,
                            properties: {
                                execSummary: { 
                                    type: Type.STRING,
                                    description: "A single, concise sentence summarizing the overall market stance. e.g., 'Cautiously bullish with a focus on key support levels.'"
                                },
                                riskCardInsight: {
                                    type: Type.STRING,
                                    description: "A one-sentence summary of the current market risk environment based on the Composite Risk Level and VIX."
                                },
                                momentumCardInsight: {
                                    type: Type.STRING,
                                    description: "A one-sentence summary of the market's momentum based on the cross status and 21MA vs 50MA spread."
                                },
                                detailedAnalysis: {
                                    type: Type.STRING,
                                    description: "A detailed market analysis in markdown format. Use the following headings exactly: '**Current Market Conditions:**', '**Risk Assessment:**', '**Strategic Opportunities:**', '**Positioning Recommendations:**'. Use markdown bullet points for lists."
                                }
                            },
                            required: ["execSummary", "riskCardInsight", "momentumCardInsight", "detailedAnalysis"]
                        }
                    }
                });
                
                const result = JSON.parse(response.text);
                result.detailedAnalysis = formatDetailedSections(result.detailedAnalysis);
                return result;

            } catch (error) {
                console.error('AI Analysis Error:', error);
                const fallbackAnalysis = `AI analysis temporarily unavailable. Market sentiment: ${data.riskLevel}. Trend: ${data.crossStatus}.`;
                return {
                    execSummary: fallbackAnalysis,
                    detailedAnalysis: fallbackAnalysis,
                    riskCardInsight: `Risk level is currently ${data.riskLevel}.`,
                    momentumCardInsight: `Momentum is indicated by a ${data.crossStatus}.`
                };
            }
        }

        // --- Main Data Orchestrator ---
        async function loadData() {
            try {
                const res = await fetch(CSV_URL);
                if (!res.ok) throw new Error('Fetch failed');
                
                const csv = await res.text();
                const rows = csv.split('\n').map(r => r.split(',').map(c => c.trim().replace(/"/g, ''))).filter(r => r.some(c => c));
                if (rows.length < 4) throw new Error('Not enough data');

                const d = rows[3];
                const marketData = {
                    qqqPrice: parseFloat(d[0]) || 0,
                    qqq21: parseFloat(d[1]) || 0,
                    qqq50: parseFloat(d[2]) || 0,
                    ma21vs50: parseFloat(d[3]) || 0,
                    vixEod: parseFloat(d[4]) || 0,
                    vixVs10d: parseFloat(d[5]) || 0,
                    qqq21ma: parseFloat(d[6]) || 0,
                    fearGreed: parseInt(d[7]) || 0,
                    vix10ma: parseFloat(d[9]) || 0,
                    riskLevel: d[10] || '--',
                    crossStatus: d[11] || '--',
                    qqq50ma: parseFloat(d[12]) || 0
                };

                const [historicalData, multiAssetData, aiAnalysis] = await Promise.all([
                    loadHistoricalData(),
                    fetchMultiAssetData(),
                    getAIAnalysis(marketData),
                ]);

                const riskScore = calculateRiskScore(marketData);
                
                return { marketData, historicalData, multiAssetData, riskScore, aiAnalysis };
            } catch (e) {
                console.error(e);
                throw e;
            }
        }

        // --- UI Update Functions ---
        function drawMiniChart(canvas, values, idPrefix) {
            if (!canvas || !canvas.getContext) return;

            const legendMinEl = document.getElementById(`${idPrefix}ChartMin`);
            const legendCurrentEl = document.getElementById(`${idPrefix}ChartCurrent`);
            const legendMaxEl = document.getElementById(`${idPrefix}ChartMax`);

            const ctx = canvas.getContext('2d');
            canvas.width = canvas.offsetWidth * 2;
            canvas.height = canvas.offsetHeight * 2;
            ctx.scale(2, 2);
            
            const w = canvas.offsetWidth;
            const h = canvas.offsetHeight;
            ctx.clearRect(0, 0, w, h);
            
            const min = Math.min(...values);
            const max = Math.max(...values);
            const range = max - min || 1;
            const padding = 10;
            
            const isUptrend = values[values.length - 1] >= values[0];
            const lineColor = isUptrend ? '#26de81' : '#ff6b6b';
            const gradientColor = isUptrend ? 'rgba(38, 222, 129, 0.2)' : 'rgba(255, 107, 107, 0.2)';
            
            const gradient = ctx.createLinearGradient(0, 0, 0, h);
            gradient.addColorStop(0, gradientColor);
            gradient.addColorStop(1, 'rgba(0, 0, 0, 0)');

            ctx.beginPath();
            values.forEach((value, i) => {
                const x = padding + (i / (values.length - 1)) * (w - padding * 2);
                const y = h - padding - ((value - min) / range) * (h - padding * 2);
                if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
            });
            ctx.lineTo(w - padding, h); ctx.lineTo(padding, h); ctx.closePath();
            ctx.fillStyle = gradient; ctx.fill();

            ctx.beginPath();
            values.forEach((value, i) => {
                const x = padding + (i / (values.length - 1)) * (w - padding * 2);
                const y = h - padding - ((value - min) / range) * (h - padding * 2);
                if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
            });
            ctx.strokeStyle = lineColor; ctx.lineWidth = 2; ctx.stroke();

            values.forEach((value, i) => {
                const x = padding + (i / (values.length - 1)) * (w - padding * 2);
                const y = h - padding - ((value - min) / range) * (h - padding * 2);
                ctx.beginPath(); ctx.arc(x, y, 3, 0, Math.PI * 2);
                ctx.fillStyle = lineColor; ctx.fill();
                ctx.strokeStyle = '#000'; ctx.lineWidth = 2; ctx.stroke();
            });

            if(legendMinEl) legendMinEl.textContent = `Min: ${min.toFixed(2)}`;
            if(legendCurrentEl) legendCurrentEl.textContent = `Current: ${values[values.length - 1].toFixed(2)}`;
            if(legendMaxEl) legendMaxEl.textContent = `Max: ${max.toFixed(2)}`;
        }

        function createTrendMiniHTML(label, values, currentValue) {
            const trendData = values.length > 0 ? values : [currentValue * 0.97, currentValue * 0.99, currentValue * 1.01, currentValue * 0.98, currentValue];
            const trend = trendData[trendData.length - 1] > trendData[0] ? '‚Üó' : '‚Üò';
            const trendClass = trendData[trendData.length - 1] > trendData[0] ? 'bullish' : 'bearish';
            
            const valuesHTML = trendData.map((v, i) => `
                <span class="trend-value ${i === trendData.length - 1 ? trendClass : ''}">${v.toFixed(2)}</span>
                ${i < trendData.length - 1 ? '<span class="trend-dot"></span>' : ''}
            `).join('');

            return `
                <span class="trend-label">${label}:</span>
                <div class="trend-values">${valuesHTML}</div>
                <span class="trend-arrow-mini ${trendClass}">${trend}</span>
            `;
        }
        
        function updateUI(data) {
            const { marketData, riskScore, multiAssetData, aiAnalysis, historicalData } = data;

            // --- Update simple text/html content ---
            document.getElementById('lastUpdated').textContent = `Last Updated: ${new Date().toLocaleString()}`;
            document.getElementById('execSummary').innerHTML = aiAnalysis.execSummary;
            document.getElementById('detailedAnalysis').innerHTML = aiAnalysis.detailedAnalysis;
            document.getElementById('qqqPrice').textContent = `$${marketData.qqqPrice.toFixed(2)}`;
            document.getElementById('qqq21').textContent = `$${marketData.qqq21.toFixed(2)}`;
            document.getElementById('qqq50').textContent = `$${marketData.qqq50.toFixed(2)}`;
            document.getElementById('fearGreedValue').textContent = marketData.fearGreed;
            document.getElementById('vixEod').textContent = marketData.vixEod.toFixed(2);
            document.getElementById('vix10ma').textContent = marketData.vix10ma.toFixed(2);
            
            // --- Update content with classes and arrows ---
            const updateMetric = (id, value, type) => {
                const el = document.getElementById(id);
                if (el) {
                    el.textContent = `${value.toFixed(2)}%${getTrendArrow(value)}`;
                    el.className = `metric-value ${getColorClass(value, type)}`;
                }
            };
            updateMetric('ma21vs50', marketData.ma21vs50, 'p');
            updateMetric('crossTrendValue', marketData.ma21vs50, 'p');
            updateMetric('qqq50maMain', marketData.qqq50ma, 'p');
            updateMetric('vixVs10d', marketData.vixVs10d, 'vix');

            // --- Risk Meter ---
            const riskPercentage = (riskScore.score / riskScore.max) * 100;
            let riskColor, riskLabelText;
            if (riskPercentage <= 25) { riskColor = '#26de81'; riskLabelText = 'LOW RISK'; }
            else if (riskPercentage <= 50) { riskColor = '#ffa502'; riskLabelText = 'MODERATE RISK'; }
            else if (riskPercentage <= 75) { riskColor = '#ff6b6b'; riskLabelText = 'HIGH RISK'; }
            else { riskColor = '#ff4757'; riskLabelText = 'CRITICAL RISK'; }

            document.getElementById('riskMeterFill').style.width = `${riskPercentage}%`;
            document.getElementById('riskMeterFill').style.background = `linear-gradient(90deg, ${riskColor} 0%, ${riskColor}dd 100%)`;
            document.getElementById('riskMeterLabel').textContent = `${Math.round(riskScore.score)}/${riskScore.max} - ${riskLabelText}`;
            document.getElementById('riskBreakdown').innerHTML = `
                <div class="risk-factor"><span class="risk-factor-label">üìä VIX Level</span><span class="risk-factor-value">${riskScore.factors.vix.score}/30 - ${riskScore.factors.vix.label}</span></div>
                <div class="risk-factor"><span class="risk-factor-label">üìà Price Position</span><span class="risk-factor-value">${riskScore.factors.position.score}/25 - ${riskScore.factors.position.label}</span></div>
                <div class="risk-factor"><span class="risk-factor-label">üîÑ Momentum</span><span class="risk-factor-value">${riskScore.factors.momentum.score}/20 - ${riskScore.factors.momentum.label}</span></div>
                <div class="risk-factor"><span class="risk-factor-label">üò® Sentiment</span><span class="risk-factor-value">${riskScore.factors.sentiment.score}/25 - ${riskScore.factors.sentiment.label}</span></div>`;

            // --- Badges ---
            document.getElementById('riskBadgeContainer').innerHTML = `<span class="status-badge badge-${riskLabelText.toLowerCase().replace(' ', '-')}">${riskLabelText}</span>`;
            const isBullish = marketData.crossStatus.toLowerCase().includes('bull');
            document.getElementById('crossBadgeContainer').innerHTML = `<span class="status-badge ${isBullish ? 'badge-golden-cross' : 'badge-death-cross'}">${isBullish ? 'BULLISH SIGNAL' : 'BEARISH SIGNAL'}</span>`;
            const fgs = getFearGreedStatus(marketData.fearGreed);
            document.getElementById('fearGreedBadgeContainer').innerHTML = `<span class="status-badge ${fgs.class}">${fgs.text}</span>`;
            document.getElementById('fearGreedValue').className = `metric-value ${fgs.class.replace('badge-','')}`;

            // --- AI Insights in cards ---
            if (aiAnalysis.riskCardInsight) {
                document.getElementById('riskCardInsight').textContent = aiAnalysis.riskCardInsight;
                document.getElementById('riskCardInsightContainer').style.display = 'flex';
            }
            if (aiAnalysis.momentumCardInsight) {
                document.getElementById('momentumCardInsight').textContent = aiAnalysis.momentumCardInsight;
                document.getElementById('momentumCardInsightContainer').style.display = 'flex';
            }

            // --- Multi Asset Grid ---
            const assets = [
                { symbol: 'QQQ', data: { price: marketData.qqqPrice, change: 0, change_pct: marketData.qqq21ma, ma21: marketData.qqq21, ma50: marketData.qqq50, description: 'Nasdaq 100 ETF' } },
                { symbol: 'SPY', data: { ...multiAssetData.SPY, description: 'S&P 500 ETF' } },
                { symbol: 'TLT', data: { ...multiAssetData.TLT, description: '20+ Year Treasury' } },
                { symbol: 'GLD', data: { ...multiAssetData.GLD, description: 'Gold ETF' } }
            ];
            document.getElementById('multiAssetGrid').innerHTML = assets.map(({ symbol, data }) => `
                <div class="asset-card">
                    <div class="asset-header">
                        <div><div class="asset-name">${symbol}</div><div style="font-size: 0.85em; color: #888;">${data.description}</div></div>
                        <div style="text-align: right;"><div class="asset-price">$${data.price.toFixed(2)}</div></div>
                    </div>
                    <div class="asset-change ${data.change_pct >= 0 ? 'bullish' : 'bearish'}">
                        ${data.change_pct >= 0 ? '‚ñ≤' : '‚ñº'} ${Math.abs(data.change_pct).toFixed(2)}%
                        ${symbol !== 'QQQ' ? ` ($${Math.abs(data.change).toFixed(2)})` : ''}
                    </div>
                    <div style="font-size: 0.85em; color: #888; margin-top: 10px;">
                        <div>21MA: $${data.ma21.toFixed(2)}</div><div>50MA: $${data.ma50.toFixed(2)}</div>
                    </div>
                </div>`).join('');

            // --- Mini Trends and Charts ---
            document.getElementById('vixTrend').innerHTML = createTrendMiniHTML('5-Day VIX', historicalData.vix, marketData.vixEod);
            document.getElementById('maTrend').innerHTML = createTrendMiniHTML('5-Day 21vs50', historicalData.ma21vs50, marketData.ma21vs50);
            document.getElementById('priceTrend').innerHTML = createTrendMiniHTML('5-Day QQQ', historicalData.qqq, marketData.qqqPrice);
            document.getElementById('fearGreedTrend').innerHTML = createTrendMiniHTML('5-Day F&G', historicalData.fearGreed, marketData.fearGreed);

            drawMiniChart(document.getElementById('qqqChart'), historicalData.qqq.length > 0 ? historicalData.qqq : [marketData.qqqPrice], 'qqq');
            drawMiniChart(document.getElementById('maChart'), historicalData.ma21vs50.length > 0 ? historicalData.ma21vs50 : [marketData.ma21vs50], 'ma');
            drawMiniChart(document.getElementById('fgChart'), historicalData.fearGreed.length > 0 ? historicalData.fearGreed : [marketData.fearGreed], 'fg');
        }

        // --- App Initialization ---
        function setPage(page) {
            document.getElementById('page-dashboard').style.display = page === 'dashboard' ? 'block' : 'none';
            document.getElementById('page-glossary').style.display = page === 'glossary' ? 'block' : 'none';
            document.getElementById('nav-dashboard').classList.toggle('active', page === 'dashboard');
            document.getElementById('nav-glossary').classList.toggle('active', page === 'glossary');
        }

        async function main() {
            document.getElementById('nav-dashboard').addEventListener('click', () => setPage('dashboard'));
            document.getElementById('nav-glossary').addEventListener('click', () => setPage('glossary'));
            
            try {
                const data = await loadData();
                updateUI(data);
                document.getElementById('loading').style.display = 'none';
                setPage('dashboard'); // Show dashboard after loading
            } catch (e) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').textContent = `Failed to load market data: ${e.message}`;
                document.getElementById('error').style.display = 'block';
            }

            setInterval(async () => {
                try {
                    console.log("Refreshing data...");
                    const data = await loadData();
                    updateUI(data);
                } catch (e) {
                    console.error("Background refresh failed:", e);
                }
            }, 3600000); // 1 hour
        }

        main();
    </script>
</body>
</html>
