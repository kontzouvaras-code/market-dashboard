<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Risk Monitor - Real-Time Dashboard</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%2300d4ff;stop-opacity:1' /%3E%3Cstop offset='100%25' style='stop-color:%230099ff;stop-opacity:1' /%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='100' height='100' rx='20' fill='url(%23grad)'/%3E%3Cpath d='M25 50 L35 40 L45 55 L55 35 L65 45 L75 30' stroke='white' stroke-width='4' fill='none' stroke-linecap='round' stroke-linejoin='round'/%3E%3Ccircle cx='75' cy='30' r='3' fill='white'/%3E%3C/svg%3E">
    
    <!-- Modern Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #000000;
            color: #fff;
            padding: 20px;
            min-height: 100vh;
        }
        .container { max-width: 1600px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 40px; padding: 20px; }
        .header-logo {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 10px;
        }
        .logo-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #00d4ff 0%, #0099ff 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 20px rgba(0, 212, 255, 0.4);
        }
        .logo-icon svg {
            width: 30px;
            height: 30px;
        }
        .header h1 {
            font-size: 2.8em;
            font-weight: 800;
            margin-bottom: 8px;
            background: linear-gradient(45deg, #00d4ff, #0099ff, #00d4ff);
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -1px;
            animation: shimmer 3s linear infinite;
        }
        @keyframes shimmer {
            0% { background-position: 0% center; }
            100% { background-position: 200% center; }
        }
        .header-subtitle {
            font-size: 1em;
            color: #888;
            font-weight: 500;
            letter-spacing: 0.5px;
        }
        .header-disclaimer {
            font-size: 0.9em;
            color: #bbb;
            margin-top: 15px;
            padding: 15px 25px;
            background: rgba(0, 212, 255, 0.08);
            border: 1px solid rgba(0, 212, 255, 0.25);
            border-radius: 10px;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
            line-height: 1.7;
        }
        .header-disclaimer strong {
            color: #00d4ff;
            font-weight: 600;
        }
        .last-updated { color: #888; font-size: 0.9em; }
        .loading { text-align: center; padding: 40px; font-size: 1.2em; color: #00d4ff; }
        .error {
            background: rgba(255, 71, 87, 0.2);
            border: 1px solid #ff4757;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
            color: #ff4757;
        }
        
        /* Executive Summary */
        .exec-summary {
            background: rgba(0, 212, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            border: 2px solid rgba(0, 212, 255, 0.4);
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 212, 255, 0.2);
        }
        .exec-summary-header {
            color: #00d4ff;
            font-size: 1.5em;
            font-weight: 700;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .exec-summary-content {
            font-size: 1.1em;
            line-height: 1.9;
            color: #fff;
            font-weight: 500;
        }
        .tldr-badge {
            background: linear-gradient(45deg, #00d4ff, #0099ff);
            color: white;
            padding: 6px 14px;
            border-radius: 12px;
            font-size: 0.6em;
            font-weight: 700;
            letter-spacing: 1px;
        }
        
        /* Risk Score Meter */
        .risk-meter-container {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .risk-meter-title {
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 20px;
            color: #00d4ff;
            text-align: center;
        }
        .risk-meter {
            position: relative;
            height: 40px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            overflow: hidden;
            margin-bottom: 15px;
        }
        .risk-meter-fill {
            height: 100%;
            transition: width 1s ease, background 1s ease;
            border-radius: 20px;
            position: relative;
        }
        .risk-meter-label {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-weight: 700;
            font-size: 1.1em;
            color: #fff;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            z-index: 10;
        }
        .risk-breakdown {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        .risk-factor {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9em;
        }
        .risk-factor-label { color: #ccc; }
        .risk-factor-value { font-weight: 600; }
        
        /* Multi-Asset Dashboard */
        .multi-asset-section {
            margin-bottom: 30px;
        }
        .section-header {
            font-size: 1.3em;
            font-weight: 600;
            color: #00d4ff;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(0, 212, 255, 0.3);
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            display: flex;
            flex-direction: column;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 212, 255, 0.2);
        }
        .card-title { font-size: 1.1em; font-weight: 600; margin-bottom: 5px; color: #00d4ff; }
        .card-subtitle { font-size: 0.85em; color: #888; margin-bottom: 15px; }
        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        .metric:last-child { border-bottom: none; }
        .metric-label { font-size: 0.9em; color: #ccc; }
        .metric-value { font-size: 1.2em; font-weight: 600; }
        
        /* Historical Trend Mini Chart */
        .trend-mini {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }
        .trend-label {
            font-size: 0.85em;
            color: #888;
            min-width: 80px;
        }
        .trend-values {
            display: flex;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
        }
        .trend-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #666;
        }
        .trend-value {
            font-size: 0.85em;
            color: #aaa;
            font-family: 'Courier New', monospace;
        }
        .trend-arrow-mini {
            font-size: 1.2em;
            margin-left: 5px;
        }
        
        /* Visual Chart Styles */
        .visual-chart-container {
            margin-top: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .chart-title {
            font-size: 0.85em;
            color: #00d4ff;
            margin-bottom: 10px;
            font-weight: 600;
            text-align: center;
        }
        .mini-chart {
            width: 100%;
            height: 80px;
            border-radius: 4px;
        }
        .chart-legend {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 0.75em;
            color: #888;
        }
        
        /* Asset Comparison Cards */
        .asset-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .asset-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .asset-name {
            font-size: 1.2em;
            font-weight: 600;
        }
        .asset-price {
            font-size: 1.4em;
            font-weight: 700;
        }
        .asset-change {
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        /* Colors */
        .extreme-fear { color: #ff4757; }
        .fear { color: #ff6b6b; }
        .neutral { color: #ffa502; }
        .greed { color: #26de81; }
        .bullish { color: #26de81; }
        .bearish { color: #ff4757; }
        .mid-risk { color: #ffa502; }
        .low-risk { color: #26de81; }
        .high-risk { color: #ff6b6b; }
        .critical-risk { color: #8B0000; }
        
        /* Badges */
        .status-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
        }
        .badge-golden-cross {
            background: rgba(38, 222, 129, 0.3);
            color: #26de81;
            border: 2px solid #26de81;
            box-shadow: 0 0 20px rgba(38, 222, 129, 0.3);
        }
        .badge-death-cross {
            background: rgba(255, 71, 87, 0.3);
            color: #ff4757;
            border: 2px solid #ff4757;
            box-shadow: 0 0 20px rgba(255, 71, 87, 0.3);
        }
        .badge-critical-risk {
            background: rgba(139, 0, 0, 0.3);
            color: #8B0000;
            border: 2px solid #8B0000;
        }
        .badge-high-risk {
            background: rgba(255, 71, 87, 0.2);
            color: #ff4757;
            border: 2px solid #ff4757;
        }
        .badge-mid-risk {
            background: rgba(255, 165, 2, 0.2);
            color: #ffa502;
            border: 2px solid #ffa502;
        }
        .badge-low-risk {
            background: rgba(38, 222, 129, 0.2);
            color: #26de81;
            border: 2px solid #26de81;
        }
        .ai-badge {
            background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.65em;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        
        /* AI Insight Boxes for Cards */
        .ai-insight-box {
            margin-top: auto;
            padding: 12px;
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 8px;
            font-size: 0.85em;
        }
        .ai-insight-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            color: #a8b3ff;
            font-weight: 600;
            font-size: 0.9em;
        }
        .ai-badge-mini {
            background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2px 8px;
            border-radius: 6px;
            font-size: 0.75em;
            font-weight: 700;
            letter-spacing: 0.5px;
        }
        .ai-insight-content {
            color: #e0e0ff;
            line-height: 1.5;
            font-size: 0.95em;
        }
        
        /* Detailed Analysis */
        .summary-box {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            border: 1px solid rgba(255, 165, 2, 0.3);
            padding: 25px;
            margin-bottom: 30px;
            line-height: 1.8;
        }
        .detailed-analysis-header {
            color: #ffa502;
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 20px;
            text-align: center;
            padding: 15px;
            border-bottom: 2px solid rgba(255, 165, 2, 0.3);
        }
        .analysis-section {
            margin-bottom: 20px;
        }
        .section-title {
            color: #00d4ff;
            font-weight: 600;
            font-size: 1.05em;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .section-icon {
            font-size: 1.2em;
        }
        .section-content {
            color: #e0e0e0;
            font-size: 0.95em;
            line-height: 1.7;
            padding-left: 28px;
        }
        .highlight {
            color: #ffa502;
            font-weight: 600;
        }
        .key-level {
            background: rgba(255, 165, 2, 0.15);
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
        }
        .large-value { font-size: 3em; font-weight: 700; text-align: center; margin: 20px 0; }
        .trend-arrow { font-size: 1.2em; margin-left: 5px; }
        
        /* Glossary Section */
        .glossary-section {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 15px;
            padding: 40px;
            margin-top: 40px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .glossary-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 2px solid rgba(0, 212, 255, 0.3);
        }
        .glossary-icon {
            font-size: 2em;
        }
        .glossary-header h2 {
            font-size: 2em;
            font-weight: 700;
            background: linear-gradient(45deg, #00d4ff, #0099ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 0;
        }
        .glossary-intro {
            font-size: 1.1em;
            line-height: 1.8;
            color: #ccc;
            margin-bottom: 40px;
            padding: 20px;
            background: rgba(0, 212, 255, 0.05);
            border-left: 4px solid #00d4ff;
            border-radius: 8px;
        }
        .glossary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        .glossary-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .glossary-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 212, 255, 0.15);
            border-color: rgba(0, 212, 255, 0.3);
        }
        .glossary-card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }
        .glossary-emoji {
            font-size: 1.8em;
        }
        .glossary-card-header h3 {
            font-size: 1.3em;
            font-weight: 600;
            color: #00d4ff;
            margin: 0;
        }
        .glossary-content {
            color: #e0e0e0;
            line-height: 1.7;
        }
        .glossary-content p {
            margin-bottom: 15px;
        }
        .glossary-content strong {
            color: #fff;
            font-weight: 600;
        }
        .glossary-content ul {
            margin: 10px 0 15px 20px;
            padding: 0;
        }
        .glossary-content li {
            margin-bottom: 8px;
            line-height: 1.6;
        }
        .glossary-content ul ul {
            margin-top: 8px;
            margin-left: 20px;
        }
        .risk-label {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.9em;
        }
        .risk-label.low {
            background: rgba(38, 222, 129, 0.2);
            color: #26de81;
            border: 1px solid #26de81;
        }
        .risk-label.moderate {
            background: rgba(255, 165, 2, 0.2);
            color: #ffa502;
            border: 1px solid #ffa502;
        }
        .risk-label.high {
            background: rgba(255, 107, 107, 0.2);
            color: #ff6b6b;
            border: 1px solid #ff6b6b;
        }
        .risk-label.critical {
            background: rgba(139, 0, 0, 0.2);
            color: #ff4757;
            border: 1px solid #ff4757;
        }
        .vix-level, .fg-level {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 5px;
            font-weight: 600;
            font-size: 0.9em;
        }
        .vix-level.low, .fg-level.greed, .fg-level.extreme-greed {
            background: rgba(38, 222, 129, 0.2);
            color: #26de81;
        }
        .vix-level.normal, .fg-level.neutral {
            background: rgba(255, 165, 2, 0.2);
            color: #ffa502;
        }
        .vix-level.elevated, .fg-level.fear {
            background: rgba(255, 107, 107, 0.2);
            color: #ff6b6b;
        }
        .vix-level.high, .vix-level.extreme, .fg-level.extreme-fear {
            background: rgba(255, 71, 87, 0.2);
            color: #ff4757;
        }
        .glossary-footer {
            margin-top: 40px;
            padding: 25px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            border: 1px solid rgba(255, 165, 2, 0.2);
        }
        .glossary-footer p {
            margin-bottom: 15px;
            line-height: 1.7;
            color: #aaa;
            font-size: 0.9em;
        }
        .glossary-footer p:last-child {
            margin-bottom: 0;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .glossary-grid {
                grid-template-columns: 1fr;
            }
            .glossary-section {
                padding: 25px 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-logo">
                <div class="logo-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="3 17 9 11 13 15 21 7"></polyline>
                        <polyline points="14 7 21 7 21 14"></polyline>
                    </svg>
                </div>
            </div>
            <h1>Market Risk Monitor</h1>
            <div class="header-subtitle">Real-Time Market Intelligence Dashboard</div>
            <div class="header-disclaimer">
                <strong>Purpose:</strong> This dashboard is designed as a risk monitoring and technical analysis tool specifically for <strong>growth technology stocks</strong> (primarily QQQ/Nasdaq-100). All metrics, analyses, and AI-generated insights are provided for educational and informational purposes only and should not be considered financial advice. Market conditions can change rapidly‚Äîalways conduct your own due diligence and consult with qualified financial professionals before making investment decisions.
            </div>
            <div class="last-updated" id="lastUpdated">Loading...</div>
        </div>

        <div id="loading" class="loading">Loading market data...</div>
        <div id="error" class="error" style="display: none;"></div>
        
        <div id="dashboard" style="display: none;">
            <!-- Executive Summary -->
            <div class="exec-summary">
                <div class="exec-summary-header">
                    <span>üìã</span>
                    Executive Summary
                    <span class="tldr-badge">TL;DR</span>
                </div>
                <div class="exec-summary-content" id="execSummary">
                    Analyzing market conditions...
                </div>
            </div>
            
            <!-- Risk Score Meter -->
            <div class="risk-meter-container">
                <div class="risk-meter-title">üéØ Composite Risk Score</div>
                <div class="risk-meter">
                    <div class="risk-meter-fill" id="riskMeterFill"></div>
                    <div class="risk-meter-label" id="riskMeterLabel">Calculating...</div>
                </div>
                <div class="risk-breakdown" id="riskBreakdown"></div>
            </div>
            
            <!-- Multi-Asset Dashboard -->
            <div class="multi-asset-section">
                <div class="section-header">üåê Multi-Asset Overview</div>
                <div class="dashboard" id="multiAssetGrid"></div>
            </div>
            
            <!-- QQQ Primary Dashboard -->
            <div class="multi-asset-section">
                <div class="section-header">üìà QQQ Detailed Metrics</div>
                <div class="dashboard">
                    <div class="card">
                        <div class="card-title">Advanced Risk Assessment</div>
                        <div class="card-subtitle">Multi-factor algorithmic risk evaluation</div>
                        <div style="text-align: center; margin: 15px 0;">
                            <span class="status-badge" id="mainRiskBadge">--</span>
                        </div>
                        <div id="vixTrend" class="trend-mini"></div>
                        <div style="flex: 1;"></div>
                        <div class="ai-insight-box" id="riskAIInsight" style="margin-top: auto;">
                            <div class="ai-insight-header">
                                <span class="ai-badge-mini">AI</span>
                                <span>Quick Insight</span>
                            </div>
                            <div class="ai-insight-content">Analyzing risk factors...</div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-title">Golden/Death Cross Analysis</div>
                        <div class="card-subtitle">21-Day vs 50-Day MA crossover</div>
                        <div style="text-align: center; margin: 15px 0;">
                            <span class="status-badge" id="mainCrossBadge">--</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Short-term Trend (21 vs 50)</span>
                            <span class="metric-value" id="crossTrendValue">--</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">QQQ Distance from 50MA</span>
                            <span class="metric-value" id="qqq50maMain">--</span>
                        </div>
                        <div id="maTrend" class="trend-mini"></div>
                        <div class="ai-insight-box" id="crossAIInsight">
                            <div class="ai-insight-header">
                                <span class="ai-badge-mini">AI</span>
                                <span>Quick Insight</span>
                            </div>
                            <div class="ai-insight-content">Analyzing momentum...</div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-title">QQQ Moving Averages</div>
                        <div class="card-subtitle">Price relative to key MAs</div>
                        <div class="metric">
                            <span class="metric-label">Current Price</span>
                            <span class="metric-value" id="qqqPrice">--</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">21-Day MA</span>
                            <span class="metric-value" id="qqq21">--</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">50-Day MA</span>
                            <span class="metric-value" id="qqq50">--</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">21 vs 50 Trend</span>
                            <span class="metric-value" id="ma21vs50">--</span>
                        </div>
                        <div id="priceTrend" class="trend-mini"></div>
                        <div class="ai-insight-box" id="maAIInsight">
                            <div class="ai-insight-header">
                                <span class="ai-badge-mini">AI</span>
                                <span>Quick Insight</span>
                            </div>
                            <div class="ai-insight-content">Analyzing price position...</div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-title">Market Sentiment & Volatility</div>
                        <div class="card-subtitle">Fear indicators and sentiment composite</div>
                        <div class="metric">
                            <span class="metric-label">VIX (Fear Index)</span>
                            <span class="metric-value" id="vixEod">--</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">VIX 10-Day MA</span>
                            <span class="metric-value" id="vix10ma">--</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">VIX vs 10-Day Avg</span>
                            <span class="metric-value" id="vixVs10d">--</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">CNN Fear & Greed</span>
                            <span class="metric-value" id="fearGreedValue">--</span>
                        </div>
                        <div style="text-align: center; margin-top: 10px;">
                            <span class="status-badge" id="fearGreedBadge">--</span>
                        </div>
                        <div id="fearGreedTrend" class="trend-mini"></div>
                        <div class="ai-insight-box" id="sentimentAIInsight">
                            <div class="ai-insight-header">
                                <span class="ai-badge-mini">AI</span>
                                <span>Quick Insight</span>
                            </div>
                            <div class="ai-insight-content">Analyzing sentiment...</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Visual Trend Charts -->
            <div class="multi-asset-section">
                <div class="section-header">üìà 5-Day Trend Analysis</div>
                <div class="dashboard">
                    <div class="card">
                        <div class="visual-chart-container">
                            <div class="chart-title">QQQ Price Movement</div>
                            <canvas id="qqqChart" class="mini-chart"></canvas>
                            <div class="chart-legend">
                                <span id="qqqChartMin">--</span>
                                <span id="qqqChartCurrent" style="color: #00d4ff; font-weight: 600;">Current: --</span>
                                <span id="qqqChartMax">--</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="visual-chart-container">
                            <div class="chart-title">21MA vs 50MA Spread</div>
                            <canvas id="maChart" class="mini-chart"></canvas>
                            <div class="chart-legend">
                                <span id="maChartMin">--</span>
                                <span id="maChartCurrent" style="color: #00d4ff; font-weight: 600;">Current: --</span>
                                <span id="maChartMax">--</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="visual-chart-container">
                            <div class="chart-title">Fear & Greed Index</div>
                            <canvas id="fgChart" class="mini-chart"></canvas>
                            <div class="chart-legend">
                                <span id="fgChartMin">--</span>
                                <span id="fgChartCurrent" style="color: #00d4ff; font-weight: 600;">Current: --</span>
                                <span id="fgChartMax">--</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Detailed Analysis -->
            <div class="summary-box">
                <div class="detailed-analysis-header">
                    üìä Detailed Market Analysis
                    <span class="ai-badge" style="margin-left: 10px;">CLAUDE AI</span>
                </div>
                <div id="detailedAnalysis">Analyzing market conditions...</div>
            </div>
            
            <!-- Glossary Link Section -->
            <div style="text-align: center; margin: 40px 0; padding: 30px; background: rgba(0, 212, 255, 0.05); border-radius: 15px; border: 1px solid rgba(0, 212, 255, 0.2);">
                <h3 style="color: #00d4ff; margin-bottom: 15px; font-size: 1.3em;">üìö Want to Learn More?</h3>
                <p style="color: #ccc; margin-bottom: 20px; font-size: 1em;">Explore our comprehensive methodology and intelligence glossary to understand how all metrics are calculated and what they mean.</p>
                <a href="glossary.html" style="display: inline-block; padding: 15px 40px; background: linear-gradient(45deg, #00d4ff, #0099ff); color: white; text-decoration: none; border-radius: 10px; font-weight: 600; font-size: 1.05em; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0, 212, 255, 0.3);">
                    View Methodology & Glossary ‚Üí
                </a>
            </div>
        </div>
    </div>

    <script>
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ9zKKjsxivMTlhDdAnsf3py3xCQZfZbcZtdV20FFKGwEpJXzIofIk-qYWDCCw1eP5QMOjNfQpB5wLH/pub?gid=2141065289&single=true&output=csv';
        
        const HISTORICAL_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ9zKKjsxivMTlhDdAnsf3py3xCQZfZbcZtdV20FFKGwEpJXzIofIk-qYWDCCw1eP5QMOjNfQpB5wLH/pub?gid=192889417&single=true&output=csv';
        
        // Historical data storage
        let historicalData = {
            vix: [],
            qqq: [],
            ma21vs50: [],
            fearGreed: []
        };

        function getTrendArrow(v) {
            return v > 0 ? ' ‚Üë' : v < 0 ? ' ‚Üì' : '';
        }

        function getColorClass(v, t) {
            if (t === 'vix') return v < 20 ? 'neutral' : v < 30 ? 'fear' : 'extreme-fear';
            return v > 0 ? 'bullish' : 'bearish';
        }

        function getFearGreedStatus(v) {
            if (v <= 25) return { text: 'EXTREME FEAR', class: 'badge-extreme-fear' };
            if (v <= 45) return { text: 'FEAR', class: 'badge-fear' };
            if (v <= 55) return { text: 'NEUTRAL', class: 'badge-neutral' };
            if (v <= 75) return { text: 'GREED', class: 'badge-greed' };
            return { text: 'EXTREME GREED', class: 'badge-greed' };
        }
        
        function calculateRiskScore(data) {
            let score = 0;
            const factors = {};
            
            // VIX Factor (0-30 points)
            const vix10 = parseFloat(data.vix10ma);
            if (vix10 >= 30) { score += 30; factors.vix = { score: 30, label: 'Critical' }; }
            else if (vix10 >= 25) { score += 22; factors.vix = { score: 22, label: 'High' }; }
            else if (vix10 >= 20) { score += 15; factors.vix = { score: 15, label: 'Elevated' }; }
            else { score += 5; factors.vix = { score: 5, label: 'Low' }; }
            
            // Price vs MA Factor (0-25 points)
            const qqq21ma = parseFloat(data.qqq21ma);
            const qqq50ma = parseFloat(data.qqq50ma);
            if (qqq21ma < 0 && qqq50ma < 0) { score += 25; factors.position = { score: 25, label: 'Below All MAs' }; }
            else if (qqq21ma < 0) { score += 15; factors.position = { score: 15, label: 'Below 21MA' }; }
            else if (qqq50ma < 0) { score += 10; factors.position = { score: 10, label: 'Below 50MA' }; }
            else { score += 0; factors.position = { score: 0, label: 'Above MAs' }; }
            
            // Cross Status Factor (0-20 points)
            const ma21vs50 = parseFloat(data.ma21vs50);
            if (ma21vs50 < 0) { score += 20; factors.momentum = { score: 20, label: 'Death Cross' }; }
            else if (ma21vs50 < 1) { score += 10; factors.momentum = { score: 10, label: 'Weak Golden' }; }
            else { score += 0; factors.momentum = { score: 0, label: 'Golden Cross' }; }
            
            // Fear & Greed Factor (0-25 points)
            const fg = parseFloat(data.fearGreed);
            if (fg <= 25) { score += 20; factors.sentiment = { score: 20, label: 'Extreme Fear' }; }
            else if (fg <= 45) { score += 12; factors.sentiment = { score: 12, label: 'Fear' }; }
            else if (fg >= 75) { score += 15; factors.sentiment = { score: 15, label: 'Extreme Greed' }; }
            else { score += 5; factors.sentiment = { score: 5, label: 'Neutral' }; }
            
            return { score, factors, max: 100 };
        }
        
        function updateRiskMeter(data) {
            const risk = calculateRiskScore(data);
            const percentage = (risk.score / risk.max) * 100;
            
            const fill = document.getElementById('riskMeterFill');
            const label = document.getElementById('riskMeterLabel');
            
            // Set color based on risk level
            let color;
            let riskLabel;
            if (percentage <= 25) { color = '#26de81'; riskLabel = 'LOW RISK'; }
            else if (percentage <= 50) { color = '#ffa502'; riskLabel = 'MODERATE RISK'; }
            else if (percentage <= 75) { color = '#ff6b6b'; riskLabel = 'HIGH RISK'; }
            else { color = '#8B0000'; riskLabel = 'CRITICAL RISK'; }
            
            fill.style.width = percentage + '%';
            fill.style.background = `linear-gradient(90deg, ${color} 0%, ${color}dd 100%)`;
            label.textContent = `${Math.round(risk.score)}/${risk.max} - ${riskLabel}`;
            
            // Update breakdown
            const breakdown = document.getElementById('riskBreakdown');
            breakdown.innerHTML = `
                <div class="risk-factor">
                    <span class="risk-factor-label">üìä VIX Level</span>
                    <span class="risk-factor-value">${risk.factors.vix.score}/30 - ${risk.factors.vix.label}</span>
                </div>
                <div class="risk-factor">
                    <span class="risk-factor-label">üìà Price Position</span>
                    <span class="risk-factor-value">${risk.factors.position.score}/25 - ${risk.factors.position.label}</span>
                </div>
                <div class="risk-factor">
                    <span class="risk-factor-label">üîÑ Momentum</span>
                    <span class="risk-factor-value">${risk.factors.momentum.score}/20 - ${risk.factors.momentum.label}</span>
                </div>
                <div class="risk-factor">
                    <span class="risk-factor-label">üò® Sentiment</span>
                    <span class="risk-factor-value">${risk.factors.sentiment.score}/25 - ${risk.factors.sentiment.label}</span>
                </div>
            `;
        }
        
        function createTrendMini(label, values, currentValue) {
            if (!values || values.length === 0) {
                // Mock historical data for demonstration
                values = [currentValue * 0.97, currentValue * 0.99, currentValue * 1.01, currentValue * 0.98, currentValue];
            }
            
            const trend = values[values.length - 1] > values[0] ? '‚Üó' : '‚Üò';
            const trendClass = values[values.length - 1] > values[0] ? 'bullish' : 'bearish';
            
            return `
                <span class="trend-label">${label}:</span>
                <div class="trend-values">
                    ${values.map((v, i) => `
                        <span class="trend-value ${i === values.length - 1 ? trendClass : ''}">${typeof v === 'number' ? v.toFixed(2) : v}</span>
                        ${i < values.length - 1 ? '<span class="trend-dot"></span>' : ''}
                    `).join('')}
                    <span class="trend-arrow-mini ${trendClass}">${trend}</span>
                </div>
            `;
        }
        
        function drawMiniChart(canvasId, values, label) {
            const canvas = document.getElementById(canvasId);
            if (!canvas || !values || values.length === 0) return;
            
            const ctx = canvas.getContext('2d');
            const width = canvas.width = canvas.offsetWidth * 2; // 2x for retina
            const height = canvas.height = canvas.offsetHeight * 2;
            ctx.scale(2, 2);
            
            const w = canvas.offsetWidth;
            const h = canvas.offsetHeight;
            
            // Clear canvas
            ctx.clearRect(0, 0, w, h);
            
            // Calculate data range
            const min = Math.min(...values);
            const max = Math.max(...values);
            const range = max - min || 1; // Avoid division by zero
            const padding = 10;
            
            // Determine trend color
            const isUptrend = values[values.length - 1] >= values[0];
            const lineColor = isUptrend ? '#26de81' : '#ff6b6b';
            const gradientColor = isUptrend ? 'rgba(38, 222, 129, 0.2)' : 'rgba(255, 107, 107, 0.2)';
            
            // Create gradient
            const gradient = ctx.createLinearGradient(0, 0, 0, h);
            gradient.addColorStop(0, gradientColor);
            gradient.addColorStop(1, 'rgba(0, 0, 0, 0)');
            
            // Draw area
            ctx.beginPath();
            values.forEach((value, i) => {
                const x = padding + (i / (values.length - 1)) * (w - padding * 2);
                const y = h - padding - ((value - min) / range) * (h - padding * 2);
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });
            ctx.lineTo(w - padding, h - padding);
            ctx.lineTo(padding, h - padding);
            ctx.closePath();
            ctx.fillStyle = gradient;
            ctx.fill();
            
            // Draw line
            ctx.beginPath();
            values.forEach((value, i) => {
                const x = padding + (i / (values.length - 1)) * (w - padding * 2);
                const y = h - padding - ((value - min) / range) * (h - padding * 2);
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });
            ctx.strokeStyle = lineColor;
            ctx.lineWidth = 2;
            ctx.stroke();
            
            // Draw points
            values.forEach((value, i) => {
                const x = padding + (i / (values.length - 1)) * (w - padding * 2);
                const y = h - padding - ((value - min) / range) * (h - padding * 2);
                
                ctx.beginPath();
                ctx.arc(x, y, 3, 0, Math.PI * 2);
                ctx.fillStyle = lineColor;
                ctx.fill();
                ctx.strokeStyle = '#000000';
                ctx.lineWidth = 2;
                ctx.stroke();
            });
            
            // Update legend
            const minEl = document.getElementById(canvasId.replace('Chart', 'ChartMin'));
            const maxEl = document.getElementById(canvasId.replace('Chart', 'ChartMax'));
            const currentEl = document.getElementById(canvasId.replace('Chart', 'ChartCurrent'));
            
            if (minEl) minEl.textContent = `Min: ${min.toFixed(2)}`;
            if (maxEl) maxEl.textContent = `Max: ${max.toFixed(2)}`;
            if (currentEl) currentEl.textContent = `Current: ${values[values.length - 1].toFixed(2)}`;
        }
        
        function updateVisualCharts(data) {
            console.log('üé® Updating visual charts...');
            
            // Generate or use historical data
            const qqqHistory = historicalData.qqq.length > 0 ? historicalData.qqq : 
                [parseFloat(data.qqqPrice) * 0.97, parseFloat(data.qqqPrice) * 0.99, 
                 parseFloat(data.qqqPrice) * 1.01, parseFloat(data.qqqPrice) * 0.98, 
                 parseFloat(data.qqqPrice)];
            
            const maHistory = historicalData.ma21vs50.length > 0 ? historicalData.ma21vs50 :
                [parseFloat(data.ma21vs50) * 0.95, parseFloat(data.ma21vs50) * 0.97,
                 parseFloat(data.ma21vs50) * 1.02, parseFloat(data.ma21vs50) * 1.05,
                 parseFloat(data.ma21vs50)];
            
            const fgHistory = historicalData.fearGreed.length > 0 ? historicalData.fearGreed :
                [parseFloat(data.fearGreed) + 5, parseFloat(data.fearGreed) + 2,
                 parseFloat(data.fearGreed) - 3, parseFloat(data.fearGreed) - 1,
                 parseFloat(data.fearGreed)];
            
            // Draw charts
            drawMiniChart('qqqChart', qqqHistory, 'QQQ Price');
            drawMiniChart('maChart', maHistory, '21MA vs 50MA');
            drawMiniChart('fgChart', fgHistory, 'Fear & Greed');
        }
        
        async function fetchMultiAssetData() {
            // Updated asset selection: BTC for crypto exposure, IWM for risk appetite
            return {
                SPY: { price: 580.45, change: 0.45, change_pct: 0.08, ma21: 575.20, ma50: 568.30 },
                BTC: { price: 91250.00, change: 1850.00, change_pct: 2.07, ma21: 89800.00, ma50: 87500.00 },
                IWM: { price: 218.45, change: -0.85, change_pct: -0.39, ma21: 220.10, ma50: 215.80 }
            };
        }
        
        function renderMultiAssetGrid(assets, qqqData) {
            const grid = document.getElementById('multiAssetGrid');
            
            // Add QQQ first
            const qqqChange = parseFloat(qqqData.qqq21ma);
            const qqqHtml = `
                <div class="asset-card">
                    <div class="asset-header">
                        <div>
                            <div class="asset-name">QQQ</div>
                            <div style="font-size: 0.85em; color: #888;">Nasdaq 100 ETF</div>
                        </div>
                        <div style="text-align: right;">
                            <div class="asset-price">$${qqqData.qqqPrice}</div>
                        </div>
                    </div>
                    <div class="asset-change ${qqqChange >= 0 ? 'bullish' : 'bearish'}">
                        ${qqqChange >= 0 ? '‚ñ≤' : '‚ñº'} ${Math.abs(qqqChange).toFixed(2)}%
                    </div>
                    <div style="font-size: 0.85em; color: #888; margin-top: 10px;">
                        <div>21MA: $${qqqData.qqq21}</div>
                        <div>50MA: $${qqqData.qqq50}</div>
                    </div>
                </div>
            `;
            
            // Add other assets
            const assetsHtml = Object.entries(assets).map(([symbol, data]) => {
                const changeClass = data.change >= 0 ? 'bullish' : 'bearish';
                const arrow = data.change >= 0 ? '‚ñ≤' : '‚ñº';
                let description = '';
                if (symbol === 'SPY') description = 'S&P 500 ETF';
                else if (symbol === 'BTC') description = 'Bitcoin';
                else if (symbol === 'IWM') description = 'Russell 2000 ETF';
                
                return `
                    <div class="asset-card">
                        <div class="asset-header">
                            <div>
                                <div class="asset-name">${symbol}</div>
                                <div style="font-size: 0.85em; color: #888;">${description}</div>
                            </div>
                            <div style="text-align: right;">
                                <div class="asset-price">$${data.price.toFixed(2)}</div>
                            </div>
                        </div>
                        <div class="asset-change ${changeClass}">
                            ${arrow} ${Math.abs(data.change_pct).toFixed(2)}% ($${Math.abs(data.change).toFixed(2)})
                        </div>
                        <div style="font-size: 0.85em; color: #888; margin-top: 10px;">
                            <div>21MA: $${data.ma21.toFixed(2)}</div>
                            <div>50MA: $${data.ma50.toFixed(2)}</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            grid.innerHTML = qqqHtml + assetsHtml;
        }

        function formatAIAnalysis(rawAnalysis) {
            let execSummary = '';
            let detailedAnalysis = '';
            
            if (rawAnalysis.includes('**MARKET POSITIONING**') || rawAnalysis.includes('MARKET POSITIONING:')) {
                const lines = rawAnalysis.split('\n').filter(line => line.trim());
                const firstLine = lines[0] || '';
                
                const titleMatch = firstLine.match(/\*\*MARKET POSITIONING:\s*(.+?)\*\*/i) || 
                                   firstLine.match(/MARKET POSITIONING:\s*(.+)/i);
                
                if (titleMatch) {
                    execSummary = titleMatch[1].trim();
                }
                
                if (!execSummary || execSummary.includes('**')) {
                    const conditionsMatch = rawAnalysis.match(/\*\*Current Market Conditions\*\*\s*\n(.+?)(?=\n\*\*|$)/is);
                    if (conditionsMatch) {
                        execSummary = conditionsMatch[1].trim().split('\n')[0].replace(/\*\*/g, '').substring(0, 200) + '...';
                    }
                }
                
                detailedAnalysis = formatDetailedSections(rawAnalysis);
            } else {
                const sentences = rawAnalysis.split(/[.!?]+/);
                execSummary = sentences[0] + '.';
                detailedAnalysis = '<div class="section-content">' + 
                    rawAnalysis
                        .replace(/\$(\d+)/g, '<span class="key-level">$$$1</span>')
                        .replace(/([\+\-]\d+\.?\d*%)/g, '<span class="highlight">$1</span>') +
                    '</div>';
            }
            
            return { execSummary, detailedAnalysis };
        }
        
        function formatDetailedSections(rawAnalysis) {
            let formattedHTML = '';
            const lines = rawAnalysis.split('\n');
            let currentSection = null;
            
            lines.forEach(line => {
                line = line.trim();
                if (!line) return;
                
                if (line.includes('MARKET POSITIONING') || line.includes('Market Positioning')) {
                    if (currentSection) formattedHTML += '</div></div>';
                    formattedHTML += '<div class="analysis-section"><div class="section-title"><span class="section-icon">üìä</span>Market Positioning</div><div class="section-content">';
                    currentSection = 'positioning';
                } else if (line.includes('Current Market Conditions')) {
                    if (currentSection) formattedHTML += '</div></div>';
                    formattedHTML += '<div class="analysis-section"><div class="section-title"><span class="section-icon">üìà</span>Current Market Conditions</div><div class="section-content">';
                    currentSection = 'conditions';
                } else if (line.includes('Risk Indicator') || line.includes('Risk Assessment')) {
                    if (currentSection) formattedHTML += '</div></div>';
                    formattedHTML += '<div class="analysis-section"><div class="section-title"><span class="section-icon">‚ö†Ô∏è</span>Risk Assessment</div><div class="section-content">';
                    currentSection = 'risk';
                } else if (line.includes('Strategic Opportunities') || line.includes('Opportunities')) {
                    if (currentSection) formattedHTML += '</div></div>';
                    formattedHTML += '<div class="analysis-section"><div class="section-title"><span class="section-icon">üí°</span>Strategic Opportunities</div><div class="section-content">';
                    currentSection = 'opportunities';
                } else if (line.includes('Positioning Recommendations') || line.includes('Recommendations')) {
                    if (currentSection) formattedHTML += '</div></div>';
                    formattedHTML += '<div class="analysis-section"><div class="section-title"><span class="section-icon">üéØ</span>Action Items</div><div class="section-content">';
                    currentSection = 'recommendations';
                } else if (currentSection && line.length > 0 && !line.startsWith('**MARKET')) {
                    let cleanLine = line
                        .replace(/\*\*/g, '')
                        .replace(/^\-\s+/, '‚Ä¢ ')
                        .replace(/\$(\d+)/g, '<span class="key-level">$$$1</span>');
                    
                    cleanLine = cleanLine.replace(/([\+\-]\d+\.?\d*%)/g, '<span class="highlight">$1</span>');
                    
                    formattedHTML += cleanLine + '<br>';
                }
            });
            
            if (currentSection) formattedHTML += '</div></div>';
            
            return formattedHTML;
        }

        async function getAIAnalysis(data) {
            try {
                const response = await fetch('/.netlify/functions/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    throw new Error('AI analysis failed');
                }

                const result = await response.json();
                return result.analysis;
            } catch (error) {
                console.error('AI Analysis Error:', error);
                return 'AI analysis temporarily unavailable. Market sentiment: ' + data.riskLevel + '. Trend: ' + data.crossStatus + '.';
            }
        }

        function generateRiskInsight(data) {
            const riskScore = calculateRiskScore(data).score;
            const vix = parseFloat(data.vix10ma);
            const fg = parseFloat(data.fearGreed);
            
            let insight = '';
            
            if (riskScore <= 25) {
                insight = '‚úì Favorable environment with ' + (vix < 15 ? 'low volatility' : 'controlled volatility') + 
                         '. ' + (fg > 50 ? 'Market optimism supports positioning.' : 'Cautious sentiment may present opportunities.');
            } else if (riskScore <= 50) {
                insight = '‚ö† Mixed signals detected. VIX at ' + vix.toFixed(1) + 
                         ' suggests ' + (vix < 20 ? 'moderate' : 'elevated') + ' uncertainty. ' +
                         'Consider selective positioning with stops.';
            } else if (riskScore <= 75) {
                insight = '‚ö†Ô∏è Elevated risk across multiple factors. ' +
                         (vix > 25 ? 'High volatility (' + vix.toFixed(1) + ') ' : '') +
                         'Defensive stance recommended with reduced exposure.';
            } else {
                insight = 'üõë Critical risk level. Multiple warning signals active. ' +
                         'Cash preservation priority. Wait for improved conditions.';
            }
            
            return insight;
        }

        function generateCrossInsight(data) {
            const ma21vs50 = parseFloat(data.ma21vs50);
            const qqq50ma = parseFloat(data.qqq50ma);
            const vix = parseFloat(data.vix10ma);
            
            let insight = '';
            
            if (ma21vs50 > 2) {
                insight = 'üöÄ Strong bullish momentum with ' + ma21vs50.toFixed(2) + '% spread. ' +
                         'Price ' + (qqq50ma > 0 ? qqq50ma.toFixed(2) + '% above 50MA' : 'near support') + '. ' +
                         'Trend strength supports continued upside.';
            } else if (ma21vs50 > 0) {
                insight = '‚Üó Positive but weakening momentum. 21MA/50MA spread narrowing to ' + 
                         ma21vs50.toFixed(2) + '%. Watch for potential consolidation or reversal signals.';
            } else if (ma21vs50 > -2) {
                insight = '‚Üò Bearish cross confirmed. 21MA below 50MA by ' + Math.abs(ma21vs50).toFixed(2) + '%. ' +
                         (vix > 20 ? 'Elevated volatility adds risk. ' : '') + 'Cautious approach warranted.';
            } else {
                insight = '‚ö†Ô∏è Strong bearish momentum. Death Cross with ' + Math.abs(ma21vs50).toFixed(2) + '% gap. ' +
                         'Consider defensive positioning until trend reversal confirmed.';
            }
            
            return insight;
        }

        function generateMAInsight(data) {
            const qqq21ma = parseFloat(data.qqq21ma);
            const qqq50ma = parseFloat(data.qqq50ma);
            const price = parseFloat(data.qqqPrice);
            const ma21 = parseFloat(data.qqq21);
            const ma50 = parseFloat(data.qqq50);
            
            let insight = '';
            
            if (qqq21ma > 2 && qqq50ma > 2) {
                insight = 'üí™ Strong bullish structure. Price trading well above both MAs (' + 
                         qqq21ma.toFixed(2) + '% above 21MA, ' + qqq50ma.toFixed(2) + '% above 50MA). ' +
                         'Uptrend firmly intact with room to run.';
            } else if (qqq21ma > 0 && qqq50ma > 0) {
                insight = '‚úì Healthy positioning above key support levels. ' +
                         '21MA at $' + ma21.toFixed(2) + ' and 50MA at $' + ma50.toFixed(2) + ' acting as support. ' +
                         'Dips toward MAs may offer entry opportunities.';
            } else if (qqq21ma < 0 && qqq50ma > 0) {
                insight = '‚ö† Short-term weakness with price below 21MA ($' + ma21.toFixed(2) + ') but above 50MA ($' + ma50.toFixed(2) + '). ' +
                         'Watch $' + ma50.toFixed(2) + ' as critical support level.';
            } else if (qqq21ma < 0 && qqq50ma < 0) {
                insight = 'üìâ Price below both key MAs. 21MA at $' + ma21.toFixed(2) + ' and 50MA at $' + ma50.toFixed(2) + ' now resistance. ' +
                         'Wait for reclaim of $' + ma21.toFixed(2) + ' for bullish confirmation.';
            } else {
                insight = 'üìä Price action around key moving averages. Monitor for directional break. ' +
                         '50MA at $' + ma50.toFixed(2) + ' is pivotal support/resistance level.';
            }
            
            return insight;
        }

        function generateSentimentInsight(data) {
            const vix = parseFloat(data.vixEod);
            const vix10ma = parseFloat(data.vix10ma);
            const fg = parseFloat(data.fearGreed);
            const vixVs10d = parseFloat(data.vixVs10d);
            
            let insight = '';
            
            // Extreme Fear scenario
            if (fg <= 25) {
                insight = 'üî¥ EXTREME FEAR at ' + fg + '. ' +
                         (vix > 25 ? 'VIX elevated at ' + vix.toFixed(1) + ' confirms panic. ' : '') +
                         'Historically, extreme fear levels mark near-term bottoms. ' +
                         (vixVs10d > 10 ? 'Volatility spiking - may signal capitulation.' : 'Consider accumulation opportunities.');
            }
            // Fear scenario
            else if (fg <= 45) {
                insight = 'üò® Fear dominates at ' + fg + '. VIX at ' + vix.toFixed(1) + ' shows ' +
                         (vix < 20 ? 'controlled anxiety' : 'heightened concern') + '. ' +
                         'Sentiment overly negative - contrarian opportunity if technical support holds.';
            }
            // Neutral scenario
            else if (fg <= 55) {
                insight = 'üòê Neutral sentiment (' + fg + '). Market in balance with VIX at ' + vix.toFixed(1) + '. ' +
                         'Neither fear nor greed dominating. Look to technical levels and trend for directional cues.';
            }
            // Greed scenario  
            else if (fg <= 75) {
                insight = 'üòä Greed emerging at ' + fg + '. ' +
                         (vix < 15 ? 'Low VIX (' + vix.toFixed(1) + ') suggests complacency. ' : '') +
                         'Optimism building but not yet excessive. Monitor for overheated conditions.';
            }
            // Extreme Greed scenario
            else {
                insight = 'üü¢ EXTREME GREED at ' + fg + '. VIX compressed at ' + vix.toFixed(1) + ' shows complacency. ' +
                         'Warning: Historically precedes pullbacks. Consider taking profits or tightening stops.';
            }
            
            return insight;
        }

        async function loadHistoricalData() {
            if (!HISTORICAL_CSV_URL) {
                console.log('‚ö†Ô∏è No historical CSV URL configured, using mock data');
                return false;
            }
            
            try {
                const res = await fetch(HISTORICAL_CSV_URL);
                if (!res.ok) {
                    console.error('‚ùå Failed to fetch historical CSV:', res.status);
                    return false;
                }
                
                const csv = await res.text();
                const rows = csv.split('\n').map(r => r.split(',').map(c => c.trim().replace(/"/g, '')));
                
                if (rows.length >= 5) {
                    if (rows[1] && rows[1][0] && rows[1][0].includes('QQQ')) {
                        historicalData.qqq = [rows[1][1], rows[1][2], rows[1][3], rows[1][4], rows[1][5]]
                            .map(v => parseFloat(v)).filter(v => !isNaN(v));
                    }
                    
                    if (rows[2] && rows[2][0] && rows[2][0].includes('VIX')) {
                        historicalData.vix = [rows[2][1], rows[2][2], rows[2][3], rows[2][4], rows[2][5]]
                            .map(v => parseFloat(v)).filter(v => !isNaN(v));
                    }
                    
                    if (rows[3] && rows[3][0] && rows[3][0].includes('MA21')) {
                        historicalData.ma21vs50 = [rows[3][1], rows[3][2], rows[3][3], rows[3][4], rows[3][5]]
                            .map(v => parseFloat(v)).filter(v => !isNaN(v));
                    }
                    
                    if (rows[4] && rows[4][0] && rows[4][0].includes('Fear')) {
                        historicalData.fearGreed = [rows[4][1], rows[4][2], rows[4][3], rows[4][4], rows[4][5]]
                            .map(v => parseFloat(v)).filter(v => !isNaN(v));
                    }
                    
                    return true;
                }
                
                return false;
            } catch (e) {
                console.error('‚ùå Error loading historical data:', e);
                return false;
            }
        }

        async function loadData() {
            try {
                await loadHistoricalData();
                
                const res = await fetch(CSV_URL);
                if (!res.ok) throw new Error('Fetch failed');
                
                const csv = await res.text();
                const rows = csv.split('\n').map(r => r.split(',').map(c => c.trim().replace(/"/g, ''))).filter(r => r.some(c => c));
                
                if (rows.length < 4) throw new Error('Not enough data');
                
                const d = rows[3];
                const data = {
                    qqqPrice: d[0] || '--',
                    qqq21: d[1] || '--',
                    qqq50: d[2] || '--',
                    ma21vs50: d[3] || '--',
                    vixEod: d[4] || '--',
                    vixVs10d: d[5] || '--',
                    qqq21ma: d[6] || '--',
                    fearGreed: d[7] || '--',
                    vix10ma: d[9] || '--',
                    riskLevel: d[10] || '--',
                    crossStatus: d[11] || '--',
                    qqq50ma: d[12] || '--'
                };
                
                updateDashboard(data);
                updateRiskMeter(data);
                
                const multiAssetData = await fetchMultiAssetData();
                renderMultiAssetGrid(multiAssetData, data);
                
                const analysis = await getAIAnalysis(data);
                const { execSummary, detailedAnalysis } = formatAIAnalysis(analysis);
                
                document.getElementById('execSummary').innerHTML = execSummary;
                document.getElementById('detailedAnalysis').innerHTML = detailedAnalysis;
                
            } catch (e) {
                document.getElementById('error').textContent = 'Error: ' + e.message;
                document.getElementById('error').style.display = 'block';
                document.getElementById('loading').style.display = 'none';
            }
        }

        function updateDashboard(d) {
            const set = (id, val, cls) => {
                const el = document.getElementById(id);
                if (el) {
                    if (val !== undefined) el.textContent = val;
                    if (cls) el.className = cls;
                }
            };
            
            const setHTML = (id, html) => {
                const el = document.getElementById(id);
                if (el) el.innerHTML = html;
            };
            
            set('qqqPrice', '$' + d.qqqPrice);
            set('qqq21', '$' + d.qqq21);
            set('qqq50', '$' + d.qqq50);
            
            const ma21 = parseFloat(d.ma21vs50);
            set('ma21vs50', d.ma21vs50 + getTrendArrow(ma21), 'metric-value ' + getColorClass(ma21, 'p'));
            set('crossTrendValue', d.ma21vs50 + getTrendArrow(ma21), 'metric-value ' + getColorClass(ma21, 'p'));
            
            const vix = parseFloat(d.vixEod);
            let vixColorClass = '';
            if (vix < 15) vixColorClass = 'greed';
            else if (vix < 20) vixColorClass = 'neutral';
            else if (vix < 30) vixColorClass = 'fear';
            else vixColorClass = 'extreme-fear';
            
            set('vixEod', d.vixEod, 'metric-value ' + vixColorClass);
            
            const vix10 = parseFloat(d.vixVs10d);
            set('vixVs10d', d.vixVs10d + getTrendArrow(vix10), 'metric-value ' + (vix10 > 0 ? 'fear' : 'neutral'));
            
            set('qqq21ma', d.qqq21ma, 'metric-value ' + getColorClass(parseFloat(d.qqq21ma), 'p'));
            
            const fg = parseFloat(d.fearGreed);
            const fgs = getFearGreedStatus(fg);
            
            let fgColorClass = '';
            if (fg <= 25) fgColorClass = 'extreme-fear';
            else if (fg <= 45) fgColorClass = 'fear';
            else if (fg <= 55) fgColorClass = 'neutral';
            else if (fg <= 75) fgColorClass = 'greed';
            else fgColorClass = 'greed';
            
            set('fearGreedValue', d.fearGreed, 'metric-value ' + fgColorClass);
            set('fearGreedBadge', fgs.text, 'status-badge ' + fgs.class);
            
            set('vix10ma', d.vix10ma);
            
            const vix10maVal = parseFloat(d.vix10ma);
            let vix10maColorClass = '';
            if (vix10maVal < 15) vix10maColorClass = 'greed';
            else if (vix10maVal < 20) vix10maColorClass = 'neutral';
            else if (vix10maVal < 30) vix10maColorClass = 'fear';
            else vix10maColorClass = 'extreme-fear';
            
            const vix10maEl = document.getElementById('vix10ma');
            if (vix10maEl) {
                vix10maEl.className = 'metric-value ' + vix10maColorClass;
            }
            
            const risk = d.riskLevel.toLowerCase();
            let riskClass = 'badge-low-risk';
            if (risk.includes('critical')) riskClass = 'badge-critical-risk';
            else if (risk.includes('high')) riskClass = 'badge-high-risk';
            else if (risk.includes('mid')) riskClass = 'badge-mid-risk';
            set('mainRiskBadge', d.riskLevel.toUpperCase(), 'status-badge ' + riskClass);
            
            const cross = d.crossStatus.toLowerCase().includes('bull');
            set('mainCrossBadge', cross ? 'BULLISH SIGNAL' : 'BEARISH SIGNAL', 
                'status-badge ' + (cross ? 'badge-golden-cross' : 'badge-death-cross'));
            
            const q50 = parseFloat(d.qqq50ma);
            set('qqq50maMain', d.qqq50ma + getTrendArrow(q50), 'metric-value ' + getColorClass(q50, 'p'));
            
            setHTML('vixTrend', createTrendMini('5-Day VIX', historicalData.vix, parseFloat(d.vixEod)));
            setHTML('priceTrend', createTrendMini('5-Day QQQ', historicalData.qqq, parseFloat(d.qqqPrice)));
            setHTML('maTrend', createTrendMini('5-Day 21vs50', historicalData.ma21vs50, parseFloat(d.ma21vs50)));
            setHTML('fearGreedTrend', createTrendMini('5-Day F&G', historicalData.fearGreed, parseFloat(d.fearGreed)));
            
            // Update AI insight boxes
            const riskInsightBox = document.getElementById('riskAIInsight');
            if (riskInsightBox) {
                const riskInsightContent = riskInsightBox.querySelector('.ai-insight-content');
                if (riskInsightContent) {
                    riskInsightContent.textContent = generateRiskInsight(d);
                }
            }
            
            const crossInsightBox = document.getElementById('crossAIInsight');
            if (crossInsightBox) {
                const crossInsightContent = crossInsightBox.querySelector('.ai-insight-content');
                if (crossInsightContent) {
                    crossInsightContent.textContent = generateCrossInsight(d);
                }
            }
            
            const maInsightBox = document.getElementById('maAIInsight');
            if (maInsightBox) {
                const maInsightContent = maInsightBox.querySelector('.ai-insight-content');
                if (maInsightContent) {
                    maInsightContent.textContent = generateMAInsight(d);
                }
            }
            
            const sentimentInsightBox = document.getElementById('sentimentAIInsight');
            if (sentimentInsightBox) {
                const sentimentInsightContent = sentimentInsightBox.querySelector('.ai-insight-content');
                if (sentimentInsightContent) {
                    sentimentInsightContent.textContent = generateSentimentInsight(d);
                }
            }
            
            updateVisualCharts(d);
            
            set('lastUpdated', 'Last Updated: ' + new Date().toLocaleString());
            
            document.getElementById('loading').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
        }

        loadData();
        
        // Market hours optimization - only update during trading hours
        // Saves ~80% on Claude API costs (~$2/month vs ~$10/month)
        function isMarketHours() {
            const now = new Date();
            const day = now.getUTCDay(); // 0=Sunday, 6=Saturday
            const hour = now.getUTCHours();
            
            // Convert to ET (UTC-5 or UTC-4 during DST)
            // Simplified: Assume standard time (UTC-5)
            // Market hours: 9:30 AM - 4:00 PM ET = 14:30 - 21:00 UTC
            const etHour = (hour - 5 + 24) % 24;
            
            // Monday-Friday (1-5), 9 AM - 5 PM ET
            const isWeekday = day >= 1 && day <= 5;
            const isDuringHours = etHour >= 9 && etHour <= 17;
            
            return isWeekday && isDuringHours;
        }
        
        // Check every hour if we should update
        setInterval(() => {
            if (isMarketHours()) {
                console.log('üìä Market hours - refreshing data...');
                loadData();
            } else {
                console.log('üí§ Outside market hours - skipping update');
            }
        }, 3600000); // Still check every hour, but only load during market hours
    </script>
</body>
</html>
