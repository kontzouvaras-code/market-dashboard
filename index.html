<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Risk Monitor - Enhanced</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            padding: 20px;
            min-height: 100vh;
        }
        .container { max-width: 1600px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #00d4ff, #0099ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .last-updated { color: #888; font-size: 0.9em; }
        .loading { text-align: center; padding: 40px; font-size: 1.2em; color: #00d4ff; }
        .error {
            background: rgba(255, 71, 87, 0.2);
            border: 1px solid #ff4757;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
            color: #ff4757;
        }
        
        /* Executive Summary */
        .exec-summary {
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.15) 0%, rgba(0, 153, 255, 0.1) 100%);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            border: 2px solid rgba(0, 212, 255, 0.4);
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 212, 255, 0.2);
        }
        .exec-summary-header {
            color: #00d4ff;
            font-size: 1.5em;
            font-weight: 700;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .exec-summary-content {
            font-size: 1.1em;
            line-height: 1.9;
            color: #fff;
            font-weight: 500;
        }
        .tldr-badge {
            background: linear-gradient(45deg, #00d4ff, #0099ff);
            color: white;
            padding: 6px 14px;
            border-radius: 12px;
            font-size: 0.6em;
            font-weight: 700;
            letter-spacing: 1px;
        }
        
        /* Risk Score Meter */
        .risk-meter-container {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .risk-meter-title {
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 20px;
            color: #00d4ff;
            text-align: center;
        }
        .risk-meter {
            position: relative;
            height: 40px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 20px;
            overflow: hidden;
            margin-bottom: 15px;
        }
        .risk-meter-fill {
            height: 100%;
            transition: width 1s ease, background 1s ease;
            border-radius: 20px;
            position: relative;
        }
        .risk-meter-label {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-weight: 700;
            font-size: 1.1em;
            color: #fff;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            z-index: 10;
        }
        .risk-breakdown {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        .risk-factor {
            background: rgba(0, 0, 0, 0.2);
            padding: 10px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9em;
        }
        .risk-factor-label { color: #ccc; }
        .risk-factor-value { font-weight: 600; }
        
        /* Multi-Asset Dashboard */
        .multi-asset-section {
            margin-bottom: 30px;
        }
        .section-header {
            font-size: 1.3em;
            font-weight: 600;
            color: #00d4ff;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(0, 212, 255, 0.3);
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 212, 255, 0.2);
        }
        .card-title { font-size: 1.1em; font-weight: 600; margin-bottom: 5px; color: #00d4ff; }
        .card-subtitle { font-size: 0.85em; color: #888; margin-bottom: 15px; }
        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        .metric:last-child { border-bottom: none; }
        .metric-label { font-size: 0.9em; color: #ccc; }
        .metric-value { font-size: 1.2em; font-weight: 600; }
        
        /* Historical Trend Mini Chart */
        .trend-mini {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
        }
        .trend-label {
            font-size: 0.85em;
            color: #888;
            min-width: 80px;
        }
        .trend-values {
            display: flex;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
        }
        .trend-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #666;
        }
        .trend-value {
            font-size: 0.85em;
            color: #aaa;
            font-family: 'Courier New', monospace;
        }
        .trend-arrow-mini {
            font-size: 1.2em;
            margin-left: 5px;
        }
        
        /* Visual Chart Styles */
        .visual-chart-container {
            margin-top: 15px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .chart-title {
            font-size: 0.85em;
            color: #00d4ff;
            margin-bottom: 10px;
            font-weight: 600;
            text-align: center;
        }
        .mini-chart {
            width: 100%;
            height: 80px;
            border-radius: 4px;
        }
        .chart-legend {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 0.75em;
            color: #888;
        }
        
        /* Asset Comparison Cards */
        .asset-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .asset-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .asset-name {
            font-size: 1.2em;
            font-weight: 600;
        }
        .asset-price {
            font-size: 1.4em;
            font-weight: 700;
        }
        .asset-change {
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        /* Colors */
        .extreme-fear { color: #ff4757; }
        .fear { color: #ff6b6b; }
        .neutral { color: #ffa502; }
        .greed { color: #26de81; }
        .bullish { color: #26de81; }
        .bearish { color: #ff4757; }
        .mid-risk { color: #ffa502; }
        .low-risk { color: #26de81; }
        .high-risk { color: #ff6b6b; }
        .critical-risk { color: #8B0000; }
        
        /* Badges */
        .status-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
        }
        .badge-golden-cross {
            background: rgba(38, 222, 129, 0.3);
            color: #26de81;
            border: 2px solid #26de81;
            box-shadow: 0 0 20px rgba(38, 222, 129, 0.3);
        }
        .badge-death-cross {
            background: rgba(255, 71, 87, 0.3);
            color: #ff4757;
            border: 2px solid #ff4757;
            box-shadow: 0 0 20px rgba(255, 71, 87, 0.3);
        }
        .badge-critical-risk {
            background: rgba(139, 0, 0, 0.3);
            color: #8B0000;
            border: 2px solid #8B0000;
        }
        .badge-high-risk {
            background: rgba(255, 71, 87, 0.2);
            color: #ff4757;
            border: 2px solid #ff4757;
        }
        .badge-mid-risk {
            background: rgba(255, 165, 2, 0.2);
            color: #ffa502;
            border: 2px solid #ffa502;
        }
        .badge-low-risk {
            background: rgba(38, 222, 129, 0.2);
            color: #26de81;
            border: 2px solid #26de81;
        }
        .ai-badge {
            background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.65em;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        
        /* Detailed Analysis */
        .summary-box {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            border: 1px solid rgba(255, 165, 2, 0.3);
            padding: 25px;
            margin-bottom: 30px;
            line-height: 1.8;
        }
        .detailed-analysis-header {
            color: #ffa502;
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 20px;
            text-align: center;
            padding: 15px;
            border-bottom: 2px solid rgba(255, 165, 2, 0.3);
        }
        .analysis-section {
            margin-bottom: 20px;
        }
        .section-title {
            color: #00d4ff;
            font-weight: 600;
            font-size: 1.05em;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .section-icon {
            font-size: 1.2em;
        }
        .section-content {
            color: #e0e0e0;
            font-size: 0.95em;
            line-height: 1.7;
            padding-left: 28px;
        }
        .highlight {
            color: #ffa502;
            font-weight: 600;
        }
        .key-level {
            background: rgba(255, 165, 2, 0.15);
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
        }
        .large-value { font-size: 3em; font-weight: 700; text-align: center; margin: 20px 0; }
        .trend-arrow { font-size: 1.2em; margin-left: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Market Risk Monitor</h1>
            <div class="last-updated" id="lastUpdated">Loading...</div>
        </div>

        <div id="loading" class="loading">Loading market data...</div>
        <div id="error" class="error" style="display: none;"></div>
        
        <div id="dashboard" style="display: none;">
            <!-- Executive Summary -->
            <div class="exec-summary">
                <div class="exec-summary-header">
                    <span>üìã</span>
                    Executive Summary
                    <span class="tldr-badge">TL;DR</span>
                </div>
                <div class="exec-summary-content" id="execSummary">
                    Analyzing market conditions...
                </div>
            </div>
            
            <!-- Risk Score Meter -->
            <div class="risk-meter-container">
                <div class="risk-meter-title">üéØ Composite Risk Score</div>
                <div class="risk-meter">
                    <div class="risk-meter-fill" id="riskMeterFill"></div>
                    <div class="risk-meter-label" id="riskMeterLabel">Calculating...</div>
                </div>
                <div class="risk-breakdown" id="riskBreakdown"></div>
            </div>
            
            <!-- Multi-Asset Dashboard -->
            <div class="multi-asset-section">
                <div class="section-header">üåê Multi-Asset Overview</div>
                <div class="dashboard" id="multiAssetGrid"></div>
            </div>
            
            <!-- QQQ Primary Dashboard -->
            <div class="multi-asset-section">
                <div class="section-header">üìà QQQ Detailed Metrics</div>
                <div class="dashboard">
                    <div class="card">
                        <div class="card-title">Advanced Risk Assessment</div>
                        <div class="card-subtitle">Multi-factor algorithmic risk evaluation</div>
                        <div style="text-align: center; margin: 15px 0;">
                            <span class="status-badge" id="mainRiskBadge">--</span>
                        </div>
                        <div id="vixTrend" class="trend-mini"></div>
                        <div style="margin-top: 15px; font-size: 0.85em; color: #888; line-height: 1.6;">
                            <div style="margin-bottom: 8px;">
                                <strong style="color: #ff4757;">Critical Risk:</strong> VIX 10MA ‚â•30 OR price below all MAs
                            </div>
                            <div style="margin-bottom: 8px;">
                                <strong style="color: #ff6b6b;">High Risk:</strong> VIX 10MA &gt;25 OR price below 21MA & 50MA
                            </div>
                            <div style="margin-bottom: 8px;">
                                <strong style="color: #ffa502;">Mid Risk:</strong> VIX 10MA &gt;20 OR price below 21MA
                            </div>
                            <div>
                                <strong style="color: #26de81;">Low Risk:</strong> Favorable conditions
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-title">Golden/Death Cross Analysis</div>
                        <div class="card-subtitle">21-Day vs 50-Day MA crossover</div>
                        <div style="text-align: center; margin: 15px 0;">
                            <span class="status-badge" id="mainCrossBadge">--</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Short-term Trend (21 vs 50)</span>
                            <span class="metric-value" id="crossTrendValue">--</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">QQQ Distance from 50MA</span>
                            <span class="metric-value" id="qqq50maMain">--</span>
                        </div>
                        <div id="maTrend" class="trend-mini"></div>
                    </div>
                    
                    <div class="card">
                        <div class="card-title">QQQ Moving Averages</div>
                        <div class="card-subtitle">Price relative to key MAs</div>
                        <div class="metric">
                            <span class="metric-label">Current Price</span>
                            <span class="metric-value" id="qqqPrice">--</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">21-Day MA</span>
                            <span class="metric-value" id="qqq21">--</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">50-Day MA</span>
                            <span class="metric-value" id="qqq50">--</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">21 vs 50 Trend</span>
                            <span class="metric-value" id="ma21vs50">--</span>
                        </div>
                        <div id="priceTrend" class="trend-mini"></div>
                    </div>
                    
                    <div class="card">
                        <div class="card-title">Market Sentiment & Volatility</div>
                        <div class="card-subtitle">Fear indicators and sentiment composite</div>
                        <div class="metric">
                            <span class="metric-label">VIX (Fear Index)</span>
                            <span class="metric-value" id="vixEod">--</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">VIX 10-Day MA</span>
                            <span class="metric-value" id="vix10ma">--</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">VIX vs 10-Day Avg</span>
                            <span class="metric-value" id="vixVs10d">--</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">CNN Fear & Greed</span>
                            <span class="metric-value" id="fearGreedValue">--</span>
                        </div>
                        <div style="text-align: center; margin-top: 10px;">
                            <span class="status-badge" id="fearGreedBadge">--</span>
                        </div>
                        <div id="fearGreedTrend" class="trend-mini"></div>
                    </div>
                </div>
            </div>
            
            <!-- Visual Trend Charts -->
            <div class="multi-asset-section">
                <div class="section-header">üìà 5-Day Trend Analysis</div>
                <div class="dashboard">
                    <div class="card">
                        <div class="visual-chart-container">
                            <div class="chart-title">QQQ Price Movement</div>
                            <canvas id="qqqChart" class="mini-chart"></canvas>
                            <div class="chart-legend">
                                <span id="qqqChartMin">--</span>
                                <span id="qqqChartCurrent" style="color: #00d4ff; font-weight: 600;">Current: --</span>
                                <span id="qqqChartMax">--</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="visual-chart-container">
                            <div class="chart-title">21MA vs 50MA Spread</div>
                            <canvas id="maChart" class="mini-chart"></canvas>
                            <div class="chart-legend">
                                <span id="maChartMin">--</span>
                                <span id="maChartCurrent" style="color: #00d4ff; font-weight: 600;">Current: --</span>
                                <span id="maChartMax">--</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="visual-chart-container">
                            <div class="chart-title">Fear & Greed Index</div>
                            <canvas id="fgChart" class="mini-chart"></canvas>
                            <div class="chart-legend">
                                <span id="fgChartMin">--</span>
                                <span id="fgChartCurrent" style="color: #00d4ff; font-weight: 600;">Current: --</span>
                                <span id="fgChartMax">--</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Detailed Analysis -->
            <div class="summary-box">
                <div class="detailed-analysis-header">
                    üìä Detailed Market Analysis
                    <span class="ai-badge" style="margin-left: 10px;">CLAUDE AI</span>
                </div>
                <div id="detailedAnalysis">Analyzing market conditions...</div>
            </div>
        </div>
    </div>

    <script>
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ9zKKjsxivMTlhDdAnsf3py3xCQZfZbcZtdV20FFKGwEpJXzIofIk-qYWDCCw1eP5QMOjNfQpB5wLH/pub?gid=2141065289&single=true&output=csv';
        
        // Historical data storage (mock for now - you'll populate this from your sheets)
        let historicalData = {
            vix: [],
            qqq: [],
            ma21vs50: [],
            fearGreed: []
        };

        function getTrendArrow(v) {
            return v > 0 ? ' ‚Üë' : v < 0 ? ' ‚Üì' : '';
        }

        function getColorClass(v, t) {
            if (t === 'vix') return v < 20 ? 'neutral' : v < 30 ? 'fear' : 'extreme-fear';
            return v > 0 ? 'bullish' : 'bearish';
        }

        function getFearGreedStatus(v) {
            if (v <= 25) return { text: 'EXTREME FEAR', class: 'badge-extreme-fear' };
            if (v <= 45) return { text: 'FEAR', class: 'badge-fear' };
            if (v <= 55) return { text: 'NEUTRAL', class: 'badge-neutral' };
            if (v <= 75) return { text: 'GREED', class: 'badge-greed' };
            return { text: 'EXTREME GREED', class: 'badge-greed' };
        }
        
        function calculateRiskScore(data) {
            let score = 0;
            const factors = {};
            
            // VIX Factor (0-30 points)
            const vix10 = parseFloat(data.vix10ma);
            if (vix10 >= 30) { score += 30; factors.vix = { score: 30, label: 'Critical' }; }
            else if (vix10 >= 25) { score += 22; factors.vix = { score: 22, label: 'High' }; }
            else if (vix10 >= 20) { score += 15; factors.vix = { score: 15, label: 'Elevated' }; }
            else { score += 5; factors.vix = { score: 5, label: 'Low' }; }
            
            // Price vs MA Factor (0-25 points)
            const qqq21ma = parseFloat(data.qqq21ma);
            const qqq50ma = parseFloat(data.qqq50ma);
            if (qqq21ma < 0 && qqq50ma < 0) { score += 25; factors.position = { score: 25, label: 'Below All MAs' }; }
            else if (qqq21ma < 0) { score += 15; factors.position = { score: 15, label: 'Below 21MA' }; }
            else if (qqq50ma < 0) { score += 10; factors.position = { score: 10, label: 'Below 50MA' }; }
            else { score += 0; factors.position = { score: 0, label: 'Above MAs' }; }
            
            // Cross Status Factor (0-20 points)
            const ma21vs50 = parseFloat(data.ma21vs50);
            if (ma21vs50 < 0) { score += 20; factors.momentum = { score: 20, label: 'Death Cross' }; }
            else if (ma21vs50 < 1) { score += 10; factors.momentum = { score: 10, label: 'Weak Golden' }; }
            else { score += 0; factors.momentum = { score: 0, label: 'Golden Cross' }; }
            
            // Fear & Greed Factor (0-25 points)
            const fg = parseFloat(data.fearGreed);
            if (fg <= 25) { score += 20; factors.sentiment = { score: 20, label: 'Extreme Fear' }; }
            else if (fg <= 45) { score += 12; factors.sentiment = { score: 12, label: 'Fear' }; }
            else if (fg >= 75) { score += 15; factors.sentiment = { score: 15, label: 'Extreme Greed' }; }
            else { score += 5; factors.sentiment = { score: 5, label: 'Neutral' }; }
            
            return { score, factors, max: 100 };
        }
        
        function updateRiskMeter(data) {
            const risk = calculateRiskScore(data);
            const percentage = (risk.score / risk.max) * 100;
            
            const fill = document.getElementById('riskMeterFill');
            const label = document.getElementById('riskMeterLabel');
            
            // Set color based on risk level
            let color;
            let riskLabel;
            if (percentage <= 25) { color = '#26de81'; riskLabel = 'LOW RISK'; }
            else if (percentage <= 50) { color = '#ffa502'; riskLabel = 'MODERATE RISK'; }
            else if (percentage <= 75) { color = '#ff6b6b'; riskLabel = 'HIGH RISK'; }
            else { color = '#8B0000'; riskLabel = 'CRITICAL RISK'; }
            
            fill.style.width = percentage + '%';
            fill.style.background = `linear-gradient(90deg, ${color} 0%, ${color}dd 100%)`;
            label.textContent = `${Math.round(risk.score)}/${risk.max} - ${riskLabel}`;
            
            // Update breakdown
            const breakdown = document.getElementById('riskBreakdown');
            breakdown.innerHTML = `
                <div class="risk-factor">
                    <span class="risk-factor-label">üìä VIX Level</span>
                    <span class="risk-factor-value">${risk.factors.vix.score}/30 - ${risk.factors.vix.label}</span>
                </div>
                <div class="risk-factor">
                    <span class="risk-factor-label">üìà Price Position</span>
                    <span class="risk-factor-value">${risk.factors.position.score}/25 - ${risk.factors.position.label}</span>
                </div>
                <div class="risk-factor">
                    <span class="risk-factor-label">üîÑ Momentum</span>
                    <span class="risk-factor-value">${risk.factors.momentum.score}/20 - ${risk.factors.momentum.label}</span>
                </div>
                <div class="risk-factor">
                    <span class="risk-factor-label">üò® Sentiment</span>
                    <span class="risk-factor-value">${risk.factors.sentiment.score}/25 - ${risk.factors.sentiment.label}</span>
                </div>
            `;
        }
        
        function createTrendMini(label, values, currentValue) {
            if (!values || values.length === 0) {
                // Mock historical data for demonstration
                values = [currentValue * 0.97, currentValue * 0.99, currentValue * 1.01, currentValue * 0.98, currentValue];
            }
            
            const trend = values[values.length - 1] > values[0] ? '‚Üó' : '‚Üò';
            const trendClass = values[values.length - 1] > values[0] ? 'bullish' : 'bearish';
            
            return `
                <span class="trend-label">${label}:</span>
                <div class="trend-values">
                    ${values.map((v, i) => `
                        <span class="trend-value ${i === values.length - 1 ? trendClass : ''}">${typeof v === 'number' ? v.toFixed(2) : v}</span>
                        ${i < values.length - 1 ? '<span class="trend-dot"></span>' : ''}
                    `).join('')}
                    <span class="trend-arrow-mini ${trendClass}">${trend}</span>
                </div>
            `;
        }
        
        function drawMiniChart(canvasId, values, label) {
            const canvas = document.getElementById(canvasId);
            if (!canvas || !values || values.length === 0) return;
            
            const ctx = canvas.getContext('2d');
            const width = canvas.width = canvas.offsetWidth * 2; // 2x for retina
            const height = canvas.height = canvas.offsetHeight * 2;
            ctx.scale(2, 2);
            
            const w = canvas.offsetWidth;
            const h = canvas.offsetHeight;
            
            // Clear canvas
            ctx.clearRect(0, 0, w, h);
            
            // Calculate data range
            const min = Math.min(...values);
            const max = Math.max(...values);
            const range = max - min || 1; // Avoid division by zero
            const padding = 10;
            
            // Determine trend color
            const isUptrend = values[values.length - 1] >= values[0];
            const lineColor = isUptrend ? '#26de81' : '#ff6b6b';
            const gradientColor = isUptrend ? 'rgba(38, 222, 129, 0.2)' : 'rgba(255, 107, 107, 0.2)';
            
            // Create gradient
            const gradient = ctx.createLinearGradient(0, 0, 0, h);
            gradient.addColorStop(0, gradientColor);
            gradient.addColorStop(1, 'rgba(0, 0, 0, 0)');
            
            // Draw area
            ctx.beginPath();
            values.forEach((value, i) => {
                const x = padding + (i / (values.length - 1)) * (w - padding * 2);
                const y = h - padding - ((value - min) / range) * (h - padding * 2);
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });
            ctx.lineTo(w - padding, h - padding);
            ctx.lineTo(padding, h - padding);
            ctx.closePath();
            ctx.fillStyle = gradient;
            ctx.fill();
            
            // Draw line
            ctx.beginPath();
            values.forEach((value, i) => {
                const x = padding + (i / (values.length - 1)) * (w - padding * 2);
                const y = h - padding - ((value - min) / range) * (h - padding * 2);
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });
            ctx.strokeStyle = lineColor;
            ctx.lineWidth = 2;
            ctx.stroke();
            
            // Draw points
            values.forEach((value, i) => {
                const x = padding + (i / (values.length - 1)) * (w - padding * 2);
                const y = h - padding - ((value - min) / range) * (h - padding * 2);
                
                ctx.beginPath();
                ctx.arc(x, y, 3, 0, Math.PI * 2);
                ctx.fillStyle = lineColor;
                ctx.fill();
                ctx.strokeStyle = '#1a1a2e';
                ctx.lineWidth = 2;
                ctx.stroke();
            });
            
            // Update legend
            const minEl = document.getElementById(canvasId.replace('Chart', 'ChartMin'));
            const maxEl = document.getElementById(canvasId.replace('Chart', 'ChartMax'));
            const currentEl = document.getElementById(canvasId.replace('Chart', 'ChartCurrent'));
            
            if (minEl) minEl.textContent = `Min: ${min.toFixed(2)}`;
            if (maxEl) maxEl.textContent = `Max: ${max.toFixed(2)}`;
            if (currentEl) currentEl.textContent = `Current: ${values[values.length - 1].toFixed(2)}`;
        }
        
        function updateVisualCharts(data) {
            // Generate or use historical data
            const qqqHistory = historicalData.qqq.length > 0 ? historicalData.qqq : 
                [parseFloat(data.qqqPrice) * 0.97, parseFloat(data.qqqPrice) * 0.99, 
                 parseFloat(data.qqqPrice) * 1.01, parseFloat(data.qqqPrice) * 0.98, 
                 parseFloat(data.qqqPrice)];
            
            const maHistory = historicalData.ma21vs50.length > 0 ? historicalData.ma21vs50 :
                [parseFloat(data.ma21vs50) * 0.95, parseFloat(data.ma21vs50) * 0.97,
                 parseFloat(data.ma21vs50) * 1.02, parseFloat(data.ma21vs50) * 1.05,
                 parseFloat(data.ma21vs50)];
            
            const fgHistory = historicalData.fearGreed.length > 0 ? historicalData.fearGreed :
                [parseFloat(data.fearGreed) + 5, parseFloat(data.fearGreed) + 2,
                 parseFloat(data.fearGreed) - 3, parseFloat(data.fearGreed) - 1,
                 parseFloat(data.fearGreed)];
            
            // Draw charts
            drawMiniChart('qqqChart', qqqHistory, 'QQQ Price');
            drawMiniChart('maChart', maHistory, '21MA vs 50MA');
            drawMiniChart('fgChart', fgHistory, 'Fear & Greed');
        }
        
        async function fetchMultiAssetData() {
            // For now, we'll use mock data
            // In production, you'd fetch from your Google Sheets or a financial API
            return {
                SPY: { price: 580.45, change: 0.45, change_pct: 0.08, ma21: 575.20, ma50: 568.30 },
                TLT: { price: 92.15, change: -0.32, change_pct: -0.35, ma21: 92.80, ma50: 93.50 },
                GLD: { price: 245.67, change: 1.23, change_pct: 0.50, ma21: 244.10, ma50: 242.80 }
            };
        }
        
        function renderMultiAssetGrid(assets, qqqData) {
            const grid = document.getElementById('multiAssetGrid');
            
            // Add QQQ first
            const qqqChange = parseFloat(qqqData.qqq21ma);
            const qqqHtml = `
                <div class="asset-card">
                    <div class="asset-header">
                        <div>
                            <div class="asset-name">QQQ</div>
                            <div style="font-size: 0.85em; color: #888;">Nasdaq 100 ETF</div>
                        </div>
                        <div style="text-align: right;">
                            <div class="asset-price">$${qqqData.qqqPrice}</div>
                        </div>
                    </div>
                    <div class="asset-change ${qqqChange >= 0 ? 'bullish' : 'bearish'}">
                        ${qqqChange >= 0 ? '‚ñ≤' : '‚ñº'} ${Math.abs(qqqChange).toFixed(2)}%
                    </div>
                    <div style="font-size: 0.85em; color: #888; margin-top: 10px;">
                        <div>21MA: $${qqqData.qqq21}</div>
                        <div>50MA: $${qqqData.qqq50}</div>
                    </div>
                </div>
            `;
            
            // Add other assets
            const assetsHtml = Object.entries(assets).map(([symbol, data]) => {
                const changeClass = data.change >= 0 ? 'bullish' : 'bearish';
                const arrow = data.change >= 0 ? '‚ñ≤' : '‚ñº';
                let description = '';
                if (symbol === 'SPY') description = 'S&P 500 ETF';
                else if (symbol === 'TLT') description = '20+ Year Treasury';
                else if (symbol === 'GLD') description = 'Gold ETF';
                
                return `
                    <div class="asset-card">
                        <div class="asset-header">
                            <div>
                                <div class="asset-name">${symbol}</div>
                                <div style="font-size: 0.85em; color: #888;">${description}</div>
                            </div>
                            <div style="text-align: right;">
                                <div class="asset-price">$${data.price.toFixed(2)}</div>
                            </div>
                        </div>
                        <div class="asset-change ${changeClass}">
                            ${arrow} ${Math.abs(data.change_pct).toFixed(2)}% ($${Math.abs(data.change).toFixed(2)})
                        </div>
                        <div style="font-size: 0.85em; color: #888; margin-top: 10px;">
                            <div>21MA: $${data.ma21.toFixed(2)}</div>
                            <div>50MA: $${data.ma50.toFixed(2)}</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            grid.innerHTML = qqqHtml + assetsHtml;
        }

        function formatAIAnalysis(rawAnalysis) {
            let execSummary = '';
            let detailedAnalysis = '';
            
            if (rawAnalysis.includes('**MARKET POSITIONING**') || rawAnalysis.includes('MARKET POSITIONING:')) {
                const lines = rawAnalysis.split('\n').filter(line => line.trim());
                const firstLine = lines[0] || '';
                
                const titleMatch = firstLine.match(/\*\*MARKET POSITIONING:\s*(.+?)\*\*/i) || 
                                   firstLine.match(/MARKET POSITIONING:\s*(.+)/i);
                
                if (titleMatch) {
                    execSummary = titleMatch[1].trim();
                }
                
                if (!execSummary || execSummary.includes('**')) {
                    const conditionsMatch = rawAnalysis.match(/\*\*Current Market Conditions\*\*\s*\n(.+?)(?=\n\*\*|$)/is);
                    if (conditionsMatch) {
                        execSummary = conditionsMatch[1].trim().split('\n')[0].replace(/\*\*/g, '').substring(0, 200) + '...';
                    }
                }
                
                detailedAnalysis = formatDetailedSections(rawAnalysis);
            } else {
                const sentences = rawAnalysis.split(/[.!?]+/);
                execSummary = sentences[0] + '.';
                detailedAnalysis = '<div class="section-content">' + 
                    rawAnalysis
                        .replace(/\$(\d+)/g, '<span class="key-level">$$$1</span>')
                        .replace(/([\+\-]\d+\.?\d*%)/g, '<span class="highlight">$1</span>') +
                    '</div>';
            }
            
            return { execSummary, detailedAnalysis };
        }
        
        function formatDetailedSections(rawAnalysis) {
            let formattedHTML = '';
            const lines = rawAnalysis.split('\n');
            let currentSection = null;
            
            lines.forEach(line => {
                line = line.trim();
                if (!line) return;
                
                if (line.includes('MARKET POSITIONING') || line.includes('Market Positioning')) {
                    if (currentSection) formattedHTML += '</div></div>';
                    formattedHTML += '<div class="analysis-section"><div class="section-title"><span class="section-icon">üìä</span>Market Positioning</div><div class="section-content">';
                    currentSection = 'positioning';
                } else if (line.includes('Current Market Conditions')) {
                    if (currentSection) formattedHTML += '</div></div>';
                    formattedHTML += '<div class="analysis-section"><div class="section-title"><span class="section-icon">üìà</span>Current Market Conditions</div><div class="section-content">';
                    currentSection = 'conditions';
                } else if (line.includes('Risk Indicator') || line.includes('Risk Assessment')) {
                    if (currentSection) formattedHTML += '</div></div>';
                    formattedHTML += '<div class="analysis-section"><div class="section-title"><span class="section-icon">‚ö†Ô∏è</span>Risk Assessment</div><div class="section-content">';
                    currentSection = 'risk';
                } else if (line.includes('Strategic Opportunities') || line.includes('Opportunities')) {
                    if (currentSection) formattedHTML += '</div></div>';
                    formattedHTML += '<div class="analysis-section"><div class="section-title"><span class="section-icon">üí°</span>Strategic Opportunities</div><div class="section-content">';
                    currentSection = 'opportunities';
                } else if (line.includes('Positioning Recommendations') || line.includes('Recommendations')) {
                    if (currentSection) formattedHTML += '</div></div>';
                    formattedHTML += '<div class="analysis-section"><div class="section-title"><span class="section-icon">üéØ</span>Action Items</div><div class="section-content">';
                    currentSection = 'recommendations';
                } else if (currentSection && line.length > 0 && !line.startsWith('**MARKET')) {
                    let cleanLine = line
                        .replace(/\*\*/g, '')
                        .replace(/^\-\s+/, '‚Ä¢ ')
                        .replace(/\$(\d+)/g, '<span class="key-level">$$$1</span>');
                    
                    cleanLine = cleanLine.replace(/([\+\-]\d+\.?\d*%)/g, '<span class="highlight">$1</span>');
                    
                    formattedHTML += cleanLine + '<br>';
                }
            });
            
            if (currentSection) formattedHTML += '</div></div>';
            
            return formattedHTML;
        }

        async function getAIAnalysis(data) {
            try {
                const response = await fetch('/.netlify/functions/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    throw new Error('AI analysis failed');
                }

                const result = await response.json();
                return result.analysis;
            } catch (error) {
                console.error('AI Analysis Error:', error);
                return 'AI analysis temporarily unavailable. Market sentiment: ' + data.riskLevel + '. Trend: ' + data.crossStatus + '.';
            }
        }

        async function loadData() {
            try {
                const res = await fetch(CSV_URL);
                if (!res.ok) throw new Error('Fetch failed');
                
                const csv = await res.text();
                const rows = csv.split('\n').map(r => r.split(',').map(c => c.trim().replace(/"/g, ''))).filter(r => r.some(c => c));
                
                if (rows.length < 4) throw new Error('Not enough data');
                
                const d = rows[3];
                const data = {
                    qqqPrice: d[0] || '--',
                    qqq21: d[1] || '--',
                    qqq50: d[2] || '--',
                    ma21vs50: d[3] || '--',
                    vixEod: d[4] || '--',
                    vixVs10d: d[5] || '--',
                    qqq21ma: d[6] || '--',
                    fearGreed: d[7] || '--',
                    vix10ma: d[9] || '--',
                    riskLevel: d[10] || '--',
                    crossStatus: d[11] || '--',
                    qqq50ma: d[12] || '--'
                };
                
                updateDashboard(data);
                updateRiskMeter(data);
                
                // Fetch and render multi-asset data
                const multiAssetData = await fetchMultiAssetData();
                renderMultiAssetGrid(multiAssetData, data);
                
                // Get AI analysis
                const analysis = await getAIAnalysis(data);
                const { execSummary, detailedAnalysis } = formatAIAnalysis(analysis);
                
                document.getElementById('execSummary').innerHTML = execSummary;
                document.getElementById('detailedAnalysis').innerHTML = detailedAnalysis;
                
            } catch (e) {
                document.getElementById('error').textContent = 'Error: ' + e.message;
                document.getElementById('error').style.display = 'block';
                document.getElementById('loading').style.display = 'none';
            }
        }

        function updateDashboard(d) {
            const set = (id, val, cls) => {
                const el = document.getElementById(id);
                if (el) {
                    if (val !== undefined) el.textContent = val;
                    if (cls) el.className = cls;
                }
            };
            
            const setHTML = (id, html) => {
                const el = document.getElementById(id);
                if (el) el.innerHTML = html;
            };
            
            set('qqqPrice', '$' + d.qqqPrice);
            set('qqq21', '$' + d.qqq21);
            set('qqq50', '$' + d.qqq50);
            
            const ma21 = parseFloat(d.ma21vs50);
            set('ma21vs50', d.ma21vs50 + getTrendArrow(ma21), 'metric-value ' + getColorClass(ma21, 'p'));
            set('crossTrendValue', d.ma21vs50 + getTrendArrow(ma21), 'metric-value ' + getColorClass(ma21, 'p'));
            
            const vix = parseFloat(d.vixEod);
            set('vixEod', d.vixEod, 'metric-value ' + getColorClass(vix, 'vix'));
            
            const vix10 = parseFloat(d.vixVs10d);
            set('vixVs10d', d.vixVs10d + getTrendArrow(vix10), 'metric-value ' + (vix10 > 0 ? 'fear' : 'neutral'));
            
            set('qqq21ma', d.qqq21ma, 'metric-value ' + getColorClass(parseFloat(d.qqq21ma), 'p'));
            
            const fg = parseFloat(d.fearGreed);
            const fgs = getFearGreedStatus(fg);
            set('fearGreedValue', d.fearGreed, 'metric-value ' + fgs.class.split('-')[1]);
            set('fearGreedBadge', fgs.text, 'status-badge ' + fgs.class);
            
            set('vix10ma', d.vix10ma);
            
            const risk = d.riskLevel.toLowerCase();
            let riskClass = 'badge-low-risk';
            if (risk.includes('critical')) riskClass = 'badge-critical-risk';
            else if (risk.includes('high')) riskClass = 'badge-high-risk';
            else if (risk.includes('mid')) riskClass = 'badge-mid-risk';
            set('mainRiskBadge', d.riskLevel.toUpperCase(), 'status-badge ' + riskClass);
            
            const cross = d.crossStatus.toLowerCase().includes('bull');
            set('mainCrossBadge', cross ? 'BULLISH SIGNAL' : 'BEARISH SIGNAL', 
                'status-badge ' + (cross ? 'badge-golden-cross' : 'badge-death-cross'));
            
            const q50 = parseFloat(d.qqq50ma);
            set('qqq50maMain', d.qqq50ma + getTrendArrow(q50), 'metric-value ' + getColorClass(q50, 'p'));
            
            // Add historical trend mini-charts
            setHTML('vixTrend', createTrendMini('5-Day VIX', historicalData.vix, parseFloat(d.vixEod)));
            setHTML('priceTrend', createTrendMini('5-Day QQQ', historicalData.qqq, parseFloat(d.qqqPrice)));
            setHTML('maTrend', createTrendMini('5-Day 21vs50', historicalData.ma21vs50, parseFloat(d.ma21vs50)));
            setHTML('fearGreedTrend', createTrendMini('5-Day F&G', historicalData.fearGreed, parseFloat(d.fearGreed)));
            
            // Update visual charts
            updateVisualCharts(d);
            
            set('lastUpdated', 'Last Updated: ' + new Date().toLocaleString());
            
            document.getElementById('loading').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
        }

        loadData();
        setInterval(loadData, 3600000); // Refresh every hour
    </script>
</body>
</html>
