<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Risk Monitor</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            padding: 20px;
            min-height: 100vh;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #00d4ff, #0099ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .last-updated { color: #888; font-size: 0.9em; }
        .loading { text-align: center; padding: 40px; font-size: 1.2em; color: #00d4ff; }
        .error {
            background: rgba(255, 71, 87, 0.2);
            border: 1px solid #ff4757;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
            color: #ff4757;
        }
        .summary-box {
            background: rgba(255, 165, 2, 0.1);
            border-radius: 8px;
            border-left: 4px solid #ffa502;
            padding: 15px;
            margin-bottom: 30px;
        }
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 212, 255, 0.2);
        }
        .card-title { font-size: 1.1em; font-weight: 600; margin-bottom: 5px; color: #00d4ff; }
        .card-subtitle { font-size: 0.85em; color: #888; margin-bottom: 15px; }
        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        .metric:last-child { border-bottom: none; }
        .metric-label { font-size: 0.9em; color: #ccc; }
        .metric-value { font-size: 1.2em; font-weight: 600; }
        .extreme-fear { color: #ff4757; }
        .fear { color: #ff6b6b; }
        .neutral { color: #ffa502; }
        .greed { color: #26de81; }
        .extreme-greed { color: #20bf6b; }
        .bullish { color: #26de81; }
        .bearish { color: #ff4757; }
        .mid-risk { color: #ffa502; }
        .large-value { font-size: 3em; font-weight: 700; text-align: center; margin: 20px 0; }
        .status-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
        }
        .badge-golden-cross {
            background: rgba(38, 222, 129, 0.3);
            color: #26de81;
            border: 2px solid #26de81;
            box-shadow: 0 0 20px rgba(38, 222, 129, 0.3);
        }
        .badge-death-cross {
            background: rgba(255, 71, 87, 0.3);
            color: #ff4757;
            border: 2px solid #ff4757;
            box-shadow: 0 0 20px rgba(255, 71, 87, 0.3);
        }
        .badge-critical-risk {
            background: rgba(139, 0, 0, 0.3);
            color: #8B0000;
            border: 2px solid #8B0000;
            animation: pulse 2s infinite;
        }
        .badge-high-risk {
            background: rgba(255, 71, 87, 0.2);
            color: #ff4757;
            border: 2px solid #ff4757;
        }
        .badge-low-risk {
            background: rgba(38, 222, 129, 0.2);
            color: #26de81;
            border: 2px solid #26de81;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        .badge-extreme-fear { background: rgba(255, 71, 87, 0.2); color: #ff4757; border: 1px solid #ff4757; }
        .badge-fear { background: rgba(255, 107, 107, 0.2); color: #ff6b6b; border: 1px solid #ff6b6b; }
        .badge-neutral { background: rgba(255, 165, 2, 0.2); color: #ffa502; border: 1px solid #ffa502; }
        .badge-mid-risk { background: rgba(255, 165, 2, 0.2); color: #ffa502; border: 1px solid #ffa502; }
        .badge-bullish { background: rgba(38, 222, 129, 0.2); color: #26de81; border: 1px solid #26de81; }
        .badge-greed { background: rgba(38, 222, 129, 0.2); color: #26de81; border: 1px solid #26de81; }
        .badge-extreme-greed { background: rgba(32, 191, 107, 0.2); color: #20bf6b; border: 1px solid #20bf6b; }
        .badge-bearish { background: rgba(255, 71, 87, 0.2); color: #ff4757; border: 1px solid #ff4757; }
        .legend {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-top: 30px;
        }
        .legend h3 { margin-bottom: 15px; color: #00d4ff; }
        .legend-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; }
        .legend-item {
            padding: 10px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 8px;
            font-size: 0.9em;
        }
        .legend-item strong { color: #00d4ff; display: block; margin-bottom: 5px; }
        .trend-arrow { font-size: 1.2em; margin-left: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ“Š Market Risk Monitor with AI</h1>
            <div class="last-updated" id="lastUpdated">Loading...</div>
        </div>

        <div id="loading" class="loading">Loading your market data from Google Sheets...</div>
        <div id="error" class="error" style="display: none;"></div>
        
        <div id="dashboard" style="display: none;">
            <div class="summary-box">
                <strong style="color: #ffa502;">ðŸ“Š Market Analysis</strong> <span style="color: #666; font-size: 0.9em;">(powered by Claude AI)</span><br>
                <span id="summaryText">Analyzing market conditions...</span>
            </div>
            
            <div class="dashboard">
                <div class="card">
                    <div class="card-title">ðŸŽ¯ Advanced Risk Assessment</div>
                    <div class="card-subtitle">Multi-factor algorithmic risk evaluation</div>
                    <div style="text-align: center; margin: 20px 0;">
                        <div style="font-size: 3em; font-weight: 700; margin: 10px 0;" id="mainRiskLevel">--</div>
                        <span class="status-badge" id="mainRiskBadge" style="font-size: 1.2em; padding: 10px 25px;">--</span>
                    </div>
                    <div style="margin-top: 20px; font-size: 0.85em; color: #888; line-height: 1.6;">
                        <strong style="color: #00d4ff; display: block; margin-bottom: 10px;">Risk Calculation Logic:</strong>
                        <div style="margin-bottom: 8px;">
                            <strong style="color: #ff4757;">Critical Risk:</strong> VIX 10MA â‰¥30 OR price below all MAs OR (21MA&lt;50MA + VIX&gt;25)
                        </div>
                        <div style="margin-bottom: 8px;">
                            <strong style="color: #ff6b6b;">High Risk:</strong> VIX 10MA &gt;25 OR price below 21MA & 50MA
                        </div>
                        <div style="margin-bottom: 8px;">
                            <strong style="color: #ffa502;">Mid Risk:</strong> VIX 10MA &gt;20 OR price below 21MA
                        </div>
                        <div>
                            <strong style="color: #26de81;">Low Risk:</strong> Favorable conditions across all indicators
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-title">ðŸ“ˆ Golden/Death Cross Analysis</div>
                    <div class="card-subtitle">21-Day vs 50-Day moving average crossover signal</div>
                    <div style="text-align: center; margin: 20px 0;">
                        <div style="font-size: 2.5em; font-weight: 700; margin: 10px 0;" id="mainCrossStatus">--</div>
                        <span class="status-badge" id="mainCrossBadge" style="font-size: 1.1em; padding: 10px 25px;">--</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Short-term Trend (21 vs 50)</span>
                        <span class="metric-value" id="crossTrendValue">--</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">QQQ Distance from 50MA</span>
                        <span class="metric-value" id="qqq50maMain">--</span>
                    </div>
                    <div style="margin-top: 20px; font-size: 0.85em; color: #888; line-height: 1.6;">
                        <strong style="color: #00d4ff; display: block; margin-bottom: 10px;">What This Means:</strong>
                        <div style="margin-bottom: 8px;">
                            <strong style="color: #26de81;">Golden Cross (21MA > 50MA):</strong> Bullish momentum signal. Short-term trend stronger than medium-term.
                        </div>
                        <div>
                            <strong style="color: #ff4757;">Death Cross (21MA < 50MA):</strong> Bearish momentum signal. Short-term weakness relative to medium-term.
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-title">QQQ Moving Averages</div>
                    <div class="card-subtitle">Price position relative to key moving averages</div>
                    <div class="metric">
                        <span class="metric-label">Current Price</span>
                        <span class="metric-value" id="qqqPrice">--</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">21-Day MA</span>
                        <span class="metric-value" id="qqq21">--</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">50-Day MA</span>
                        <span class="metric-value" id="qqq50">--</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Short-term Trend (21 vs 50)</span>
                        <span class="metric-value" id="ma21vs50">--</span>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-title">Short Term Sentiment</div>
                    <div class="card-subtitle">Market volatility and fear indicators</div>
                    <div class="metric">
                        <span class="metric-label">VIX End of Day (Fear Index)</span>
                        <span class="metric-value" id="vixEod">--</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">VIX vs. 10-Day Avg</span>
                        <span class="metric-value" id="vixVs10d">--</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">QQQ Distance from 21MA</span>
                        <span class="metric-value" id="qqq21ma">--</span>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-title">CNN Fear & Greed Index</div>
                    <div class="card-subtitle">Market sentiment composite (0-100 scale)</div>
                    <div class="large-value" id="fearGreedValue">--</div>
                    <div style="text-align: center;">
                        <span class="status-badge" id="fearGreedBadge">--</span>
                    </div>
                    <div style="margin-top: 15px; font-size: 0.85em; color: #888; text-align: center;">
                        0-25: Extreme Fear (potential buying opportunity)<br>
                        26-45: Fear | 46-55: Neutral | 56-75: Greed | 76-100: Extreme Greed
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-title">Mid Term Indicators</div>
                    <div class="card-subtitle">10-day volatility assessment</div>
                    <div class="metric">
                        <span class="metric-label">VIX 10-Day Moving Avg</span>
                        <span class="metric-value" id="vix10ma">--</span>
                    </div>
                    <div style="margin-top: 15px; font-size: 0.85em; color: #888;">
                        VIX 10-20: Low-Mid Risk<br>
                        VIX 20-30: Elevated Risk<br>
                        VIX 30+: High Risk
                    </div>
                </div>
            </div>
            
            <div class="legend">
                <h3>ðŸ“– Understanding the Indicators</h3>
                <div class="legend-grid">
                    <div class="legend-item">
                        <strong>Moving Averages (MA)</strong>
                        Average price over a period. Price above MA = strength, below = weakness. 21MA tracks short-term, 50MA tracks medium-term trends.
                    </div>
                    <div class="legend-item">
                        <strong>VIX (Fear Index)</strong>
                        Measures expected market volatility. Higher VIX = more fear/uncertainty. Below 20 is calm, 20-30 is elevated, above 30 is high fear.
                    </div>
                    <div class="legend-item">
                        <strong>Fear & Greed Index</strong>
                        Composite of 7 market indicators. Extreme Fear often presents buying opportunities; Extreme Greed suggests caution.
                    </div>
                    <div class="legend-item">
                        <strong>Cross Definition</strong>
                        Golden Cross (bullish): 21MA crosses above 50MA. Death Cross (bearish): 21MA crosses below 50MA. Signals trend changes.
                    </div>
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 30px; color: #666; font-size: 0.85em;">
                Auto-refreshes every 60 minutes. Powered by Claude AI. For informational purposes only, not trading advice.
            </div>
        </div>
    </div>

    <script>
        const PUBLISHED_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ9zKKjsxivMTlhDdAnsf3py3xCQZfZbcZtdV20FFKGwEpJXzIofIk-qYWDCCw1eP5QMOjNfQpB5wLH/pub?gid=2141065289&single=true&output=csv';

        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            document.getElementById('loading').style.display = 'none';
        }

        function getTrendArrow(value) {
            if (value > 0) return '<span class="trend-arrow">â†‘</span>';
            if (value < 0) return '<span class="trend-arrow">â†“</span>';
            return '';
        }

        function getColorClass(value, type) {
            if (type === 'vix') {
                if (value < 15) return 'greed';
                if (value < 20) return 'neutral';
                if (value < 30) return 'fear';
                return 'extreme-fear';
            }
            if (type === 'percent') {
                return value > 0 ? 'bullish' : 'bearish';
            }
            return 'neutral';
        }

        function getFearGreedStatus(value) {
            if (value <= 25) return { text: 'EXTREME FEAR', class: 'badge-extreme-fear', color: 'extreme-fear' };
            if (value <= 45) return { text: 'FEAR', class: 'badge-fear', color: 'fear' };
            if (value <= 55) return { text: 'NEUTRAL', class: 'badge-neutral', color: 'neutral' };
            if (value <= 75) return { text: 'GREED', class: 'badge-greed', color: 'greed' };
            return { text: 'EXTREME GREED', class: 'badge-extreme-greed', color: 'extreme-greed' };
        }

        async function getAIAnalysis(data) {
            try {
                const response = await fetch('/.netlify/functions/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    throw new Error('AI analysis failed: ' + response.status);
                }

                const result = await response.json();
                return result.analysis;
            } catch (error) {
                console.error('AI analysis error:', error);
                return 'AI analysis unavailable. Using standard analysis: ' + generateBasicSummary(data);
            }
        }

        function generateBasicSummary(data) {
            const fearGreedValue = parseFloat(data.fearGreed);
            const qqq21maPercent = parseFloat(data.qqq21ma.replace('%', ''));
            const qqq50maPercent = parseFloat(data.qqq50ma.replace('%', ''));
            
            let summary = '';
            if (fearGreedValue <= 25) {
                summary += 'Extreme Fear (' + fearGreedValue + ') suggests potential opportunity, but ';
            } else if (fearGreedValue >= 75) {
                summary += 'Extreme Greed (' + fearGreedValue + ') suggests caution warranted, ';
            } else {
                summary += 'Market sentiment is ' + getFearGreedStatus(fearGreedValue).text.toLowerCase() + ', ';
            }
            
            if (qqq21maPercent < 0) {
                summary += 'short-term weakness (QQQ below 21MA). ';
            } else {
                summary += 'short-term strength (QQQ above 21MA). ';
            }
            
            if (qqq50maPercent > 0) {
                summary += 'Long-term trend remains bullish (above 50MA).';
            } else {
                summary += 'Long-term trend is concerning (below 50MA).';
            }
            
            const vixValue = parseFloat(data.vixEod);
            if (vixValue > 20) {
                summary += ' Elevated VIX (' + vixValue + ') indicates caution warranted.';
            }
            return summary;
        }

        async function loadData() {
            try {
                const response = await fetch(PUBLISHED_CSV_URL);
                
                if (!response.ok) {
                    throw new Error('Could not fetch data from Google Sheets. Status: ' + response.status);
                }
                
                const csvText = await response.text();
                
                const rows = csvText.split('\n').map(row => {
                    const values = [];
                    let current = '';
                    let inQuotes = false;
                    
                    for (let char of row) {
                        if (char === '"') {
                            inQuotes = !inQuotes;
                        } else if (char === ',' && !inQuotes) {
                            values.push(current.trim().replace(/^"|"$/g, ''));
                            current = '';
                        } else {
                            current += char;
                        }
                    }
                    values.push(current.trim().replace(/^"|"$/g, ''));
                    return values;
                }).filter(row => row.some(cell => cell !== ''));
                
                if (rows.length < 4) {
                    throw new Error('Not enough data rows in sheet. Found ' + rows.length + ' rows.');
                }
                
                let dataRow;
                if (rows.length >= 4) {
                    dataRow = rows[3];
                } else if (rows.length >= 3) {
                    dataRow = rows[2];
                } else {
                    dataRow = rows[1];
                }
                
                const data = {
                    qqqPrice: dataRow[0] || '--',
                    qqq21: dataRow[1] || '--',
                    qqq50: dataRow[2] || '--',
                    ma21vs50: dataRow[3] || '--',
                    vixEod: dataRow[4] || '--',
                    vixVs10d: dataRow[5] || '--',
                    qqq21ma: dataRow[6] || '--',
                    fearGreed: dataRow[7] || '--',
                    fearGreedText: dataRow[8] || '--',
                    vix10ma: dataRow[9] || '--',
                    riskLevel: dataRow[10] || '--',
                    crossStatus: dataRow[11] || '--',
                    qqq50ma: dataRow[12] || '--'
                };
                
                updateDashboard(data);
            } catch (error) {
                console.error('Error loading data:', error);
                showError('Failed to load data: ' + error.message + '. Make sure your sheet is published to the web.');
            }
        }

        function updateDashboard(data) {
            document.getElementById('qqqPrice').textContent = '$' + data.qqqPrice;
            document.getElementById('qqq21').textContent = '$' + data.qqq21;
            document.getElementById('qqq50').textContent = '$' + data.qqq50;
            
            const ma21vs50Value = parseFloat(data.ma21vs50);
            const ma21vs50El = document.getElementById('ma21vs50');
            ma21vs50El.innerHTML = data.ma21vs50 + getTrendArrow(ma21vs50Value);
            ma21vs50El.className = 'metric-value ' + getColorClass(ma21vs50Value, 'percent');
            
            const crossTrendEl = document.getElementById('crossTrendValue');
            crossTrendEl.innerHTML = data.ma21vs50 + getTrendArrow(ma21vs50Value);
            crossTrendEl.className = 'metric-value ' + getColorClass(ma21vs50Value, 'percent');
            
            const vixEodValue = parseFloat(data.vixEod);
            const vixEodEl = document.getElementById('vixEod');
            vixEodEl.textContent = data.vixEod;
            vixEodEl.className = 'metric-value ' + getColorClass(vixEodValue, 'vix');
            
            const vixVs10dValue = parseFloat(data.vixVs10d);
            const vixVs10dEl = document.getElementById('vixVs10d');
            vixVs10dEl.innerHTML = data.vixVs10d + getTrendArrow(vixVs10dValue);
            vixVs10dEl.className = 'metric-value ' + (vixVs10dValue > 0 ? 'extreme-fear' : 'greed');
            
            const qqq21maValue = parseFloat(data.qqq21ma);
            const qqq21maEl = document.getElementById('qqq21ma');
            qqq21maEl.textContent = data.qqq21ma;
            qqq21maEl.className = 'metric-value ' + getColorClass(qqq21maValue, 'percent');
            
            const fearGreedValue = parseFloat(data.fearGreed);
            const fearGreedStatus = getFearGreedStatus(fearGreedValue);
            document.getElementById('fearGreedValue').textContent = data.fearGreed;
            document.getElementById('fearGreedValue').className = 'large-value ' + fearGreedStatus.color;
            document.getElementById('fearGreedBadge').textContent = fearGreedStatus.text;
            document.getElementById('fearGreedBadge').className = 'status-badge ' + fearGreedStatus.class;
            
            document.getElementById('vix10ma').textContent = data.vix10ma;
            document.getElementById('vix10ma').className = 'metric-value mid-risk';
            
            const mainRiskLevel = document.getElementById('mainRiskLevel');
            const mainRiskBadge = document.getElementById('mainRiskBadge');
            mainRiskLevel.textContent = data.riskLevel.toUpperCase();
            mainRiskBadge.textContent = data.riskLevel.toUpperCase();
            
            if (data.riskLevel.toLowerCase().includes('critical')) {
                mainRiskLevel.className = 'extreme-fear';
                mainRiskBadge.className = 'status-badge badge-critical-risk';
            } else if (data.riskLevel.toLowerCase().includes('high')) {
                mainRiskLevel.className = 'extreme-fear';
                mainRiskBadge.className = 'status-badge badge-high-risk';
            } else if (data.riskLevel.toLowerCase().includes('mid')) {
                mainRiskLevel.className = 'mid-risk';
                mainRiskBadge.className = 'status-badge badge-mid-risk';
            } else {
                mainRiskLevel.className = 'bullish';
                mainRiskBadge.className = 'status-badge badge-low-risk';
            }
            
            const mainCrossStatus = document.getElementById('mainCrossStatus');
            const mainCrossBadge = document.getElementById('mainCrossBadge');
            
            if (data.crossStatus.toLowerCase().includes('bull')) {
                mainCrossStatus.textContent = 'âš¡ GOLDEN CROSS';
                mainCrossStatus.className = 'bullish';
                mainCrossBadge.textContent = 'BULLISH SIGNAL';
                mainCrossBadge.className = 'status-badge badge-golden-cross';
            } else {
                mainCrossStatus.textContent = 'âš ï¸ DEATH CROSS';
                mainCrossStatus.className = 'bearish';
                mainCrossBadge.textContent = 'BEARISH SIGNAL';
                mainCrossBadge.className = 'status-badge badge-death-cross';
            }
            
            const qqq50maValue = parseFloat(data.qqq50ma);
            const qqq50maMainEl = document.getElementById('qqq50maMain');
            qqq50maMainEl.innerHTML = data.qqq50ma + getTrendArrow(qqq50maValue);
            qqq50maMainEl.className = 'metric-value ' + getColorClass(qqq50maValue, 'percent');
            
            document.getElementById('summaryText').textContent = 'Analyzing with Claude AI...';
            getAIAnalysis(data).then(analysis => {
                document.getElementById('summaryText').textContent = analysis;
            });
            
            const now = new Date();
            document.getElementById('lastUpdated').textContent = 'Last Updated: ' + now.toLocaleString();
            
            document.getElementById('loading').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
        }

        loadData();
        setInterval(loadData, 3600000);
    </script>
</body>
</html>